services:
  app:
    build:
      context: ./app
    image: lucheestiy-dropbox-app:custom
    container_name: dropbox-app
    restart: unless-stopped
    user: "1000:1000"
    volumes:
      - ./data:/srv
      - ./database:/database
      - ./config:/config
    networks:
      - default

  dropbox:
    image: nginx:1.25-alpine
    container_name: dropbox
    restart: unless-stopped
    ports:
      - "${DROPBOX_HOST_PORT:-8099}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/gallery.html:/usr/share/nginx/html/gallery.html:ro
      - ./nginx/analytics.html:/usr/share/nginx/html/analytics.html:ro
      - ./nginx/media-viewer.html:/usr/share/nginx/html/media-viewer.html:ro
      - ./nginx-fixed/video-player.html:/usr/share/nginx/html/video-player.html:ro
      - ./nginx/test-media.html:/usr/share/nginx/html/test-media.html:ro
      - ./nginx/stream-gallery.html:/usr/share/nginx/html/stream-gallery.html:ro
      - ./nginx/request.html:/usr/share/nginx/html/request.html:ro
      - ./nginx/droppr-theme.css:/usr/share/nginx/html/droppr-theme.css:ro
      - ./nginx/droppr-panel.js:/usr/share/nginx/html/droppr-panel.js:ro
      - ./nginx/static:/usr/share/nginx/html/static:ro
      - ./database/proxy-cache:/usr/share/nginx/html/proxy-cache:ro
      - ./database/hls-cache:/usr/share/nginx/html/hls-cache:ro
    depends_on:
      - app
    networks:
      - default

  media-server:
    build:
      context: ./media-server
    container_name: dropbox-media-server
    restart: unless-stopped
    command: gunicorn --bind 0.0.0.0:5000 --workers 4 --threads 10 --access-logfile - --error-logfile - app:app
    user: "1000:1000"
    volumes:
      - ./database:/database
      - ./data:/srv
    environment:
      - DROPPR_CACHE_DIR=/database/thumb-cache
      - DROPPR_THUMB_MAX_CONCURRENCY=1
      - DROPPR_PROXY_CACHE_DIR=/database/proxy-cache
      - DROPPR_PROXY_MAX_CONCURRENCY=1
      - DROPPR_HLS_CACHE_DIR=/database/hls-cache
      - DROPPR_REDIS_URL=redis://redis:6379/0
      - DROPPR_CELERY_BROKER_URL=redis://redis:6379/1
      - DROPPR_CELERY_RESULT_BACKEND=redis://redis:6379/1
      - DROPPR_R2_ENABLED=${DROPPR_R2_ENABLED:-false}
      - DROPPR_R2_ENDPOINT=${DROPPR_R2_ENDPOINT:-}
      - DROPPR_R2_BUCKET=${DROPPR_R2_BUCKET:-}
      - DROPPR_R2_ACCESS_KEY_ID=${DROPPR_R2_ACCESS_KEY_ID:-}
      - DROPPR_R2_SECRET_ACCESS_KEY=${DROPPR_R2_SECRET_ACCESS_KEY:-}
      - DROPPR_R2_PUBLIC_BASE_URL=${DROPPR_R2_PUBLIC_BASE_URL:-}
      - DROPPR_R2_PREFIX=${DROPPR_R2_PREFIX:-droppr-cache}
    depends_on:
      - app
      - redis
    networks:
      - default

  media-worker:
    build:
      context: ./media-server
    container_name: dropbox-media-worker
    restart: unless-stopped
    command: celery -A app.celery_app worker --loglevel=info --concurrency=2
    user: "1000:1000"
    volumes:
      - ./database:/database
      - ./data:/srv
    environment:
      - DROPPR_CACHE_DIR=/database/thumb-cache
      - DROPPR_THUMB_MAX_CONCURRENCY=1
      - DROPPR_PROXY_CACHE_DIR=/database/proxy-cache
      - DROPPR_PROXY_MAX_CONCURRENCY=1
      - DROPPR_HLS_CACHE_DIR=/database/hls-cache
      - DROPPR_REDIS_URL=redis://redis:6379/0
      - DROPPR_CELERY_BROKER_URL=redis://redis:6379/1
      - DROPPR_CELERY_RESULT_BACKEND=redis://redis:6379/1
      - DROPPR_R2_ENABLED=${DROPPR_R2_ENABLED:-false}
      - DROPPR_R2_ENDPOINT=${DROPPR_R2_ENDPOINT:-}
      - DROPPR_R2_BUCKET=${DROPPR_R2_BUCKET:-}
      - DROPPR_R2_ACCESS_KEY_ID=${DROPPR_R2_ACCESS_KEY_ID:-}
      - DROPPR_R2_SECRET_ACCESS_KEY=${DROPPR_R2_SECRET_ACCESS_KEY:-}
      - DROPPR_R2_PUBLIC_BASE_URL=${DROPPR_R2_PUBLIC_BASE_URL:-}
      - DROPPR_R2_PREFIX=${DROPPR_R2_PREFIX:-droppr-cache}
    depends_on:
      - redis
    networks:
      - default

  redis:
    image: redis:7-alpine
    container_name: dropbox-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    volumes:
      - ./database/redis:/data
    networks:
      - default

  cloudflared-dropbox:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-dropbox
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflare/config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflare/creds:/etc/cloudflared/creds:ro
    depends_on:
      - dropbox
    profiles:
      - tunnel
    networks:
      - default

networks:
  default:
    name: lucheestiy-dropbox_default
