<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dropbox File Request</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

    :root {
      --bg: #eef3fb;
      --bg-soft: #f7faff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #51607a;
      --accent: #0061ff;
      --accent-dark: #0b4bd6;
      --accent-glow: rgba(0, 97, 255, 0.24);
      --border: #d8e2f1;
      --shadow: 0 30px 70px -40px rgba(15, 23, 42, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 16px;
      font-family: "Space Grotesk", "IBM Plex Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #f4f8ff 0%, var(--bg) 45%, var(--bg-soft) 100%);
      color: var(--ink);
      overflow-x: hidden;
    }

    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(0px);
      opacity: 0.35;
      z-index: 0;
      animation: drift 16s ease-in-out infinite;
    }

    .orb.one {
      width: 240px;
      height: 240px;
      top: -60px;
      left: -80px;
      background: radial-gradient(circle at 30% 30%, rgba(0, 97, 255, 0.35), rgba(0, 97, 255, 0.08));
    }

    .orb.two {
      width: 180px;
      height: 180px;
      bottom: -40px;
      right: -30px;
      background: radial-gradient(circle at 30% 30%, rgba(14, 116, 144, 0.3), rgba(14, 116, 144, 0.06));
      animation-delay: -6s;
    }

    @keyframes drift {
      0%, 100% { transform: translate3d(0, 0, 0); }
      50% { transform: translate3d(12px, -18px, 0); }
    }

    .card {
      position: relative;
      z-index: 1;
      width: min(720px, 100%);
      background: var(--card);
      border-radius: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(216, 226, 241, 0.9);
      padding: 32px;
      display: grid;
      gap: 20px;
      animation: rise 0.6s ease;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .mark {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, #0b5fff, #2c8cff);
      box-shadow: 0 14px 28px -18px rgba(11, 95, 255, 0.8);
      position: relative;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .brand .meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand .meta .name {
      font-size: 18px;
      font-weight: 700;
    }

    .brand .meta .tag {
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 3vw, 32px);
      letter-spacing: -0.02em;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.5;
    }

    .status {
      padding: 10px 14px;
      border-radius: 12px;
      background: #f4f7ff;
      border: 1px solid rgba(0, 97, 255, 0.12);
      color: #29407a;
      font-size: 13px;
    }

    .status.error {
      background: #fff1f1;
      border-color: rgba(239, 68, 68, 0.24);
      color: #a02c2c;
    }

    .status.success {
      background: #ecfdf3;
      border-color: rgba(16, 185, 129, 0.28);
      color: #0f6f4f;
    }

    .dropzone {
      border: 2px dashed rgba(0, 97, 255, 0.25);
      border-radius: 20px;
      padding: 24px;
      background: #f8faff;
      display: grid;
      gap: 12px;
      text-align: center;
      transition: border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }

    .dropzone.drag {
      border-color: var(--accent);
      background: #eef4ff;
    }

    .dropzone h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: -0.01em;
    }

    .dropzone p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .dropzone .hint {
      font-size: 12px;
      color: #71829f;
    }

    .controls {
      display: grid;
      gap: 16px;
    }

    .password {
      display: none;
      gap: 8px;
    }

    .password.show {
      display: grid;
    }

    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #607191;
      font-weight: 600;
    }

    input[type="password"] {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: "IBM Plex Sans", system-ui, sans-serif;
      outline: none;
    }

    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 97, 255, 0.12);
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button.primary {
      appearance: none;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, var(--accent), #3384ff);
      box-shadow: 0 18px 36px -24px rgba(0, 97, 255, 0.7);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }

    button.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button.primary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 40px -24px rgba(0, 97, 255, 0.8);
    }

    .file-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 12px;
    }

    .file-item {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      background: #ffffff;
      display: grid;
      gap: 8px;
    }

    .file-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .file-name {
      font-size: 14px;
      font-weight: 600;
    }

    .file-size {
      font-size: 12px;
      color: var(--muted);
    }

    .file-status {
      font-size: 12px;
      color: var(--muted);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #eef2f9;
      overflow: hidden;
    }

    .progress-bar span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #5aa0ff);
      transition: width 0.2s ease;
    }

    .footer {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer strong {
      color: var(--ink);
    }

    @media (max-width: 640px) {
      .card { padding: 24px; }
      .actions { flex-direction: column; align-items: stretch; }
      button.primary { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="orb one"></div>
  <div class="orb two"></div>

  <main class="card">
    <div class="brand">
      <div class="mark">DB</div>
      <div class="meta">
        <div class="name">Dropbox</div>
        <div class="tag">File Request</div>
      </div>
    </div>

    <div>
      <h1>Upload your files</h1>
      <p class="subtitle" id="subtitle">Loading request details...</p>
    </div>

    <div class="status" id="status">Preparing request...</div>

    <div class="dropzone" id="dropzone">
      <input id="file-input" type="file" multiple hidden>
      <h3>Drag and drop files</h3>
      <p>or click to browse from your device</p>
      <div class="hint">Multiple files supported. Keep the tab open until upload completes.</div>
    </div>

    <div class="controls">
      <div class="password" id="password-block">
        <label for="password-input">Request password</label>
        <input id="password-input" type="password" autocomplete="off" placeholder="Enter password">
      </div>
      <div class="actions">
        <button class="primary" id="upload-btn" disabled>Upload files</button>
      </div>
    </div>

    <ul class="file-list" id="file-list"></ul>

    <div class="footer">
      <div><strong>Private upload</strong> - recipients cannot browse existing files.</div>
      <div id="expires-note"></div>
    </div>
  </main>

  <script>
    (function () {
      var hashMatch = String(window.location.pathname || "").match(/\/request\/([^/]+)/);
      var requestHash = hashMatch ? hashMatch[1] : "";

      var subtitleEl = document.getElementById("subtitle");
      var statusEl = document.getElementById("status");
      var expiresEl = document.getElementById("expires-note");
      var passwordBlock = document.getElementById("password-block");
      var passwordInput = document.getElementById("password-input");
      var dropzone = document.getElementById("dropzone");
      var fileInput = document.getElementById("file-input");
      var uploadBtn = document.getElementById("upload-btn");
      var fileList = document.getElementById("file-list");

      var requiresPassword = false;
      var uploading = false;
      var queue = [];
      var counter = 0;

      function setStatus(text, tone) {
        statusEl.textContent = text || "";
        statusEl.className = "status" + (tone ? (" " + tone) : "");
      }

      function formatBytes(bytes) {
        if (!bytes && bytes !== 0) return "";
        var sizes = ["B", "KB", "MB", "GB", "TB"];
        var i = 0;
        var value = bytes;
        while (value >= 1024 && i < sizes.length - 1) {
          value /= 1024;
          i += 1;
        }
        return value.toFixed(value >= 10 || i === 0 ? 0 : 1) + " " + sizes[i];
      }

      function formatExpires(seconds) {
        if (!seconds) return "";
        var hours = Math.ceil(seconds / 3600);
        if (hours < 24) return "Expires in " + hours + " hour" + (hours === 1 ? "" : "s");
        var days = Math.ceil(hours / 24);
        return "Expires in " + days + " day" + (days === 1 ? "" : "s");
      }

      function createRow(entry) {
        var li = document.createElement("li");
        li.className = "file-item";
        li.innerHTML =
          '<div class="file-row">' +
            '<div class="file-name"></div>' +
            '<div class="file-size"></div>' +
          '</div>' +
          '<div class="file-row">' +
            '<div class="file-status"></div>' +
            '<div class="file-progress"></div>' +
          '</div>' +
          '<div class="progress-bar"><span></span></div>';

        li.querySelector(".file-name").textContent = entry.name;
        li.querySelector(".file-size").textContent = formatBytes(entry.size);
        entry.el = li;
        updateRow(entry);
        return li;
      }

      function updateRow(entry) {
        if (!entry.el) return;
        var status = entry.status || "queued";
        var statusLabel = status === "uploading" ? "Uploading" : (status === "done" ? "Complete" : (status === "error" ? "Failed" : "Queued"));
        entry.el.querySelector(".file-status").textContent = statusLabel;
        entry.el.querySelector(".file-progress").textContent = status === "done" ? "100%" : (entry.progress || 0) + "%";
        entry.el.querySelector(".progress-bar span").style.width = (entry.progress || 0) + "%";
      }

      function updateButtonState() {
        if (!queue.length || uploading) {
          uploadBtn.disabled = true;
          return;
        }
        if (requiresPassword && !passwordInput.value) {
          uploadBtn.disabled = true;
          return;
        }
        uploadBtn.disabled = false;
      }

      function addFiles(list) {
        var files = Array.prototype.slice.call(list || []);
        if (!files.length) return;
        files.forEach(function (file) {
          counter += 1;
          var rel = file.webkitRelativePath || file.name;
          var entry = {
            id: counter,
            file: file,
            name: file.name,
            size: file.size,
            relPath: rel,
            status: "queued",
            progress: 0,
            el: null,
          };
          queue.push(entry);
          fileList.appendChild(createRow(entry));
        });
        setStatus("Ready to upload " + files.length + " file" + (files.length === 1 ? "" : "s") + ".", "");
        updateButtonState();
      }

      function uploadEntry(entry) {
        return new Promise(function (resolve) {
          entry.status = "uploading";
          entry.progress = 0;
          updateRow(entry);

          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/api/droppr/requests/" + encodeURIComponent(requestHash) + "/upload");
          xhr.timeout = 0;
          if (requiresPassword && passwordInput.value) {
            xhr.setRequestHeader("X-Request-Password", encodeURIComponent(passwordInput.value));
          }

          xhr.upload.onprogress = function (event) {
            if (!event.lengthComputable) return;
            entry.progress = Math.max(1, Math.floor((event.loaded / event.total) * 100));
            updateRow(entry);
          };

          xhr.onerror = function () {
            entry.status = "error";
            updateRow(entry);
            setStatus("Upload failed. Please try again.", "error");
            resolve();
          };

          xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
              entry.status = "done";
              entry.progress = 100;
              updateRow(entry);
              resolve();
              return;
            }

            if (xhr.status === 401) {
              setStatus("Password required or incorrect.", "error");
            } else if (xhr.status === 410) {
              setStatus("This request link has expired.", "error");
            } else {
              setStatus("Upload failed (" + xhr.status + ").", "error");
            }

            entry.status = "error";
            updateRow(entry);
            resolve();
          };

          var form = new FormData();
          form.append("file", entry.file, entry.file.name);
          if (entry.relPath && entry.relPath !== entry.file.name) {
            form.append("relative_path", entry.relPath);
          }
          xhr.send(form);
        });
      }

      function uploadAll() {
        if (uploading || !queue.length) return;
        if (requiresPassword && !passwordInput.value) {
          setStatus("Password required to upload.", "error");
          return;
        }
        uploading = true;
        uploadBtn.disabled = true;
        setStatus("Uploading files...", "");

        var chain = Promise.resolve();
        queue.forEach(function (entry) {
          if (entry.status === "done") return;
          chain = chain.then(function () {
            return uploadEntry(entry);
          });
        });

        chain.then(function () {
          uploading = false;
          var failures = queue.filter(function (entry) { return entry.status === "error"; });
          if (failures.length) {
            setStatus("Some files failed. Fix and click Upload again to retry.", "error");
          } else {
            setStatus("All uploads complete. You can close this tab.", "success");
          }
          updateButtonState();
        });
      }

      function initDropzone() {
        dropzone.addEventListener("click", function () {
          if (!requestHash) return;
          fileInput.click();
        });

        fileInput.addEventListener("change", function (event) {
          addFiles(event.target.files || []);
          fileInput.value = "";
        });

        dropzone.addEventListener("dragover", function (event) {
          event.preventDefault();
          dropzone.classList.add("drag");
        });

        dropzone.addEventListener("dragleave", function () {
          dropzone.classList.remove("drag");
        });

        dropzone.addEventListener("drop", function (event) {
          event.preventDefault();
          dropzone.classList.remove("drag");
          if (event.dataTransfer && event.dataTransfer.files) {
            addFiles(event.dataTransfer.files);
          }
        });
      }

      function loadRequest() {
        if (!requestHash) {
          setStatus("Invalid request link.", "error");
          subtitleEl.textContent = "This link is missing its request ID.";
          dropzone.classList.add("disabled");
          return;
        }

        fetch("/api/droppr/requests/" + encodeURIComponent(requestHash))
          .then(function (res) {
            return res.text().then(function (text) {
              var data = null;
              if (text) {
                try { data = JSON.parse(text); } catch (e) { data = null; }
              }
              if (!res.ok) {
                var msg = (data && data.error) ? data.error : "Request unavailable";
                throw new Error(msg);
              }
              return data || {};
            });
          })
          .then(function (data) {
            requiresPassword = !!data.requires_password;
            var folder = data.folder || "Uploads";
            subtitleEl.textContent = "Uploads go directly to the folder: " + folder + ".";
            if (requiresPassword) {
              passwordBlock.classList.add("show");
              setStatus("Password required to upload.", "");
            } else {
              setStatus("Ready to upload files.", "");
            }
            if (data.expires_in) {
              expiresEl.textContent = formatExpires(data.expires_in);
            } else {
              expiresEl.textContent = "No expiration set.";
            }
            updateButtonState();
          })
          .catch(function (err) {
            setStatus(String(err && err.message ? err.message : err), "error");
            subtitleEl.textContent = "This request link is not available.";
            uploadBtn.disabled = true;
          });
      }

      uploadBtn.addEventListener("click", uploadAll);
      passwordInput.addEventListener("input", updateButtonState);

      initDropzone();
      loadRequest();
    })();
  </script>
</body>
</html>
