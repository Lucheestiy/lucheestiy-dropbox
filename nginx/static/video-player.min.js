(function(){function q(e){return String(e||"").split("/").map(t=>encodeURIComponent(t)).join("/")}function ve(e){if(e==null)return null;const t=String(e);if(t.startsWith("/")||t.startsWith("\\")||t.includes("\\"))return null;const i=t.split("/").filter(Boolean);return!i.length||i.some(s=>s==="..")?null:i.join("/")}function B(e,t){const i=document.getElementById("errorTitle"),s=document.getElementById("errorMessage"),l=document.getElementById("error");i&&(i.textContent=e||"Error"),s&&(s.textContent=t||""),l==null||l.classList.add("show")}const Q=new URLSearchParams(window.location.search),v=(Q.get("share")||"").trim(),Ae=(Q.get("file")||"").trim();if(!/^[A-Za-z0-9_-]{1,64}$/.test(v)){B("Invalid link","Missing or invalid share hash.");return}const F=ve(Ae);if(!F){B("Invalid link","Missing or invalid file path.");return}const Y=F.split("/").pop()||F;document.title=Y+" - Dropbox";const ue=document.getElementById("fileName");ue&&(ue.textContent=Y);const N=document.getElementById("fileSub");N&&(N.textContent=v);const fe=`/api/share/${v}/video-sources/${q(F)}`,J=`/api/public/dl/${v}/${q(F)}?inline=true`,Me=`/api/share/${v}/file/${q(F)}?download=1`,Pe=`/gallery/${v}`,n=document.getElementById("video"),K=document.getElementById("bufferText"),X=document.getElementById("timeText"),x=document.getElementById("bufferFill"),de=document.getElementById("backLink"),G=document.getElementById("downloadLink"),$=document.getElementById("openLink"),O=document.getElementById("qualityBtn"),ce=document.getElementById("reloadBtn"),he=!!(K&&X&&x);de&&(de.href=Pe),G&&(G.href=Me,G.download=Y),$&&($.href=J);const R=["auto","hd","fast"],me={auto:"Auto",hd:"HD",fast:"Fast"};let a=(Q.get("quality")||"auto").trim().toLowerCase();R.includes(a)||(a="auto");const r={original:{url:J,size:null},fast:{url:null,ready:!1,size:null},hd:{url:null,ready:!1,size:null},hls:{url:null,ready:!1,variants:[]}};let u=null,m=!1,S=null,k=null,z=0,D=null,Z=0,V=!1,ye=0,U=0,A=0,w=!1,j=null,p=null,E=!1,T=!1,_=!1,L=null,W=null,ge=0,I=!1;const Fe=3500,De=8e3,_e=15e3,He=5*60*1e3,Be=3,xe=5e3,ee=1200,ke=2e3,Ue=10*60*1e3,pe=800,Ce=navigator.userAgent||"",b=!(/iPad|iPhone|iPod/i.test(Ce)||navigator.platform==="MacIntel"&&(navigator.maxTouchPoints||0)>1);function Ne(){return!!n.canPlayType&&!!n.canPlayType("application/vnd.apple.mpegurl")}function Se(){return!!window.Hls&&window.Hls.isSupported()}function M(){return Ne()||Se()}function te(){if(L){try{L.destroy()}catch{}L=null}}function ne(e){if(!Number.isFinite(e)||e<0)return"--:--";const t=Math.floor(e),i=Math.floor(t/3600),s=Math.floor(t%3600/60),l=t%60;return i>0?`${i}:${String(s).padStart(2,"0")}:${String(l).padStart(2,"0")}`:`${s}:${String(l).padStart(2,"0")}`}function P(){j&&(clearTimeout(j),j=null)}function $e(){const e=Math.max(0,U-1),t=_e*Math.pow(2,e);return Math.min(He,t)}function Te(){ye=Date.now(),U=Math.min(10,U+1),A=ye+$e(),w=U>=Be,P(),p&&(clearTimeout(p),p=null)}function Oe(){U=0,A=0,w=!1}function Re(){P(),j=setTimeout(()=>{u==="hd"&&(n.paused||n.seeking||n.error||(Oe(),o()))},xe)}function re(e){a==="auto"&&b&&(w||(p&&clearTimeout(p),p=setTimeout(()=>{p=null,Ke()},Math.max(0,e))))}function Le(e){return e==="hls"?"Adaptive":e==="hd"?"HD":e==="fast"?"Fast":"Original"}function ze(e){const t=r[e]&&r[e].url;$&&($.href=t||r.original.url||J)}function C(){const e=me[a]||"Auto",t=u?Le(u):"";O&&(O.textContent=a==="auto"&&t?`${e} (${t})`:e),N&&(N.textContent=v),ze(u||"original")}function je(){if(n.error)return"Error";if(n.seeking)return"Seeking";const e=Date.now()-(z||0);return n.readyState===0&&e>2e3?u==="fast"?"Loading fast preview…":u==="hd"?"Loading HD…":"Loading original…":!n.paused&&n.readyState<3?"Buffering":n.paused?n.currentTime>0?"Paused":n.readyState>=2?"Ready":"Loading":"Playing"}function We(){const e=Number.isFinite(n.duration)?n.duration:null,t=Number.isFinite(n.currentTime)?n.currentTime:0,i=[];try{const c=n.buffered;for(let f=0;f<c.length;f++){const g=c.start(f),oe=c.end(f);Number.isFinite(g)&&Number.isFinite(oe)&&oe>g&&i.push([g,oe])}}catch{}let s=0;for(const[c,f]of i)s+=f-c;let l=0;for(const[c,f]of i)if(t>=c&&t<=f){l=Math.max(0,f-t);break}const d=e&&e>0?Math.max(0,Math.min(1,s/e)):null;return{dur:e,ct:t,pct:d,ahead:l}}function o(){if(!he)return;const e=je(),t=We();X&&(X.textContent=t.dur?`${ne(t.ct)} / ${ne(t.dur)}`:ne(t.ct));const i=me[a]||"Auto",s=u?Le(u):"";let l=s?`${i} • ${s} • ${e}`:`${i} • ${e}`;if(t.pct!=null&&x){const d=Math.round(t.pct*100);l+=` • Buffered ${d}%`,t.ahead>0&&(l+=` • Ahead ${Math.round(t.ahead)}s`),x.style.width=`${Math.max(0,Math.min(100,t.pct*100)).toFixed(1)}%`}else x&&(x.style.width="0%");if((a==="auto"||a==="hd")&&!r.hd.ready&&E&&(l+=" • Preparing HD…"),(a==="auto"||a==="fast")&&!r.fast.ready&&T&&(l+=" • Preparing Fast…"),a==="auto"&&M()&&!r.hls.ready&&_&&(l+=" • Preparing Adaptive…"),a==="auto"&&!b&&(l+=" • iOS: Auto=HD"),a==="auto"&&r.hd.ready&&u!=="hd"){if(w)l+=" • HD off (tap HD)";else if(A&&Date.now()<A){const d=Math.max(1,Math.ceil((A-Date.now())/1e3));l+=` • HD retry in ${d}s`}}K&&(K.textContent=l)}function ie(){he&&(k||(k=setInterval(o,500)))}function qe(){k&&(clearInterval(k),k=null)}function Qe(e,t){if(!t)return e;const i=e.includes("?")?"&":"?";return e+i+"v="+Date.now()}function be(e,t){const i=r[e]&&r[e].url;return i?Qe(i,t):null}function H(e,t){const i=t!=null&&t.avoid?String(t.avoid):"";return e==="hls"?i!=="hls"&&r.hls.ready&&M()?"hls":i!=="hd"&&r.hd.ready?"hd":i!=="fast"&&r.fast.ready?"fast":"original":e==="hd"?i!=="hd"&&r.hd.ready?"hd":i!=="fast"&&r.fast.ready?"fast":"original":e==="fast"?i!=="fast"&&r.fast.ready?"fast":i!=="hd"&&r.hd.ready?"hd":"original":i!=="hd"&&r.hd.ready?"hd":i!=="fast"&&r.fast.ready?"fast":"original"}function ae(){return a==="fast"?"fast":a==="hd"?"hd":M()&&r.hls.ready?"hls":b&&(w||n.paused||I||n.seeking)?"fast":"hd"}function we(e){const t=(e==null?void 0:e.allowFastSwitch)!==!1;ge=Date.now(),I||(I=!0,p&&(clearTimeout(p),p=null),a==="auto"&&(!r.fast.ready&&!T&&h(["fast"]),b&&t&&r.fast.ready&&u!=="fast"&&!m&&y("fast",{time:n.currentTime,shouldPlay:!n.paused})),o()),W&&clearTimeout(W),W=setTimeout(()=>{Date.now()-ge<pe||(W=null,I&&(I=!1,o(),a==="auto"&&!n.paused&&(b&&!w&&!r.hd.ready&&!E&&h(["hd"]),re(ee))))},pe+25)}function Ee(){S&&clearTimeout(S),S=null}function Ye(e){const t=Number.isFinite(e==null?void 0:e.time)?Math.max(0,e.time):null,i=!!(e!=null&&e.shouldPlay),s=!!(e!=null&&e.cacheBust),l=be("hls",s);if(!l){B("Could not load video","Missing adaptive stream.");return}m=!0,Ee(),u="hls",z=Date.now(),C(),n.pause(),te(),n.removeAttribute("src"),n.load(),o();function d(){m=!1,C()}function c(){try{if(t!=null){const f=Number.isFinite(n.duration)?n.duration:null;n.currentTime=f?Math.min(t,Math.max(0,f-.25)):t}}catch{}}Se()&&window.Hls?(L=new window.Hls({maxBufferLength:60,backBufferLength:60}),L.attachMedia(n),L.on(window.Hls.Events.MEDIA_ATTACHED,()=>{L.loadSource(l)}),L.on(window.Hls.Events.MANIFEST_PARSED,()=>{c(),i&&n.play().catch(()=>{}),d()}),L.on(window.Hls.Events.ERROR,(f,g)=>{g&&g.fatal&&(te(),d(),a==="auto"&&y(H("fast",{avoid:"hls"}),{time:t??void 0,shouldPlay:i}))})):(n.addEventListener("loadedmetadata",()=>{c(),i&&n.play().catch(()=>{}),d()},{once:!0}),n.src=l,n.load()),ie(),o()}function y(e,t){if(e==="hls"){Ye(t);return}const i=Number.isFinite(t==null?void 0:t.time)?Math.max(0,t.time):null,s=!!(t!=null&&t.shouldPlay),l=!!(t!=null&&t.cacheBust),d=be(e,l);if(!d){B("Could not load video","Missing source URL.");return}m=!0,Ee(),u=e,z=Date.now(),C();const c=n.currentTime||0;function f(){m=!1,C()}n.pause(),te(),n.removeAttribute("src"),n.load(),o(),n.addEventListener("loadedmetadata",()=>{try{if(i!=null){const g=Number.isFinite(n.duration)?n.duration:null;n.currentTime=g?Math.min(i,Math.max(0,g-.25)):i}}catch{}s&&n.play().catch(()=>{}),f()},{once:!0}),n.addEventListener("error",()=>{if(f(),a==="auto"&&e==="hd"){Te();const g=Number.isFinite(i)?i:c;y(H("fast",{avoid:"hd"}),{time:g,shouldPlay:s})}},{once:!0}),n.src=d,n.load(),ie(),o()}async function le(e){var s;const t=new AbortController,i=setTimeout(()=>t.abort(),8e3);try{const l=fe+(fe.includes("?")?"&":"?")+"t="+Date.now();let d;return(s=e==null?void 0:e.prepareTargets)!=null&&s.length?d=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prepare:e.prepareTargets}),signal:t.signal,cache:"no-store"}):d=await fetch(l,{signal:t.signal,cache:"no-store"}),d.ok?await d.json():null}catch{return null}finally{clearTimeout(i)}}function se(e){if(!(!e||typeof e!="object")){if(e.original&&typeof e.original=="object"){typeof e.original.url=="string"&&e.original.url&&(r.original.url=e.original.url);const t=Number(e.original.size);Number.isFinite(t)&&t>0&&(r.original.size=Math.floor(t))}if(e.fast&&typeof e.fast=="object"){typeof e.fast.url=="string"&&e.fast.url&&(r.fast.url=e.fast.url),typeof e.fast.ready=="boolean"&&(r.fast.ready=e.fast.ready);const t=Number(e.fast.size);r.fast.size=Number.isFinite(t)&&t>0?Math.floor(t):null}if(e.hd&&typeof e.hd=="object"){typeof e.hd.url=="string"&&e.hd.url&&(r.hd.url=e.hd.url),typeof e.hd.ready=="boolean"&&(r.hd.ready=e.hd.ready);const t=Number(e.hd.size);r.hd.size=Number.isFinite(t)&&t>0?Math.floor(t):null}e.hls&&typeof e.hls=="object"&&(typeof e.hls.url=="string"&&e.hls.url&&(r.hls.url=e.hls.url),typeof e.hls.ready=="boolean"&&(r.hls.ready=e.hls.ready),Array.isArray(e.hls.variants)&&(r.hls.variants=e.hls.variants)),C(),o()}}function Je(){D||(Z=Date.now(),D=setInterval(async()=>{if(Z&&Date.now()-Z>Ue){clearInterval(D),D=null,T=!1,E=!1,o();return}if(!V){V=!0;try{const e=r.fast.ready,t=r.hd.ready,i=r.hls.ready,s=await le();s&&se(s);const l=r.fast.ready,d=r.hd.ready,c=r.hls.ready;if(!e&&l){T=!1,o();const f=!n.paused;m||(a==="fast"&&u!=="fast"?y("fast",{time:n.currentTime,shouldPlay:f}):a==="auto"&&b&&(I||n.seeking||n.paused)&&u!=="fast"&&y("fast",{time:n.currentTime,shouldPlay:f}))}if(!t&&d&&(E=!1,o(),!m))if(a==="hd"){const f=()=>{if(!m&&!(a!=="hd"||u==="hd")){if(I||n.seeking){setTimeout(f,500);return}y("hd",{time:n.currentTime,shouldPlay:!n.paused})}};f()}else a==="auto"&&b&&!n.paused&&re(ee);!i&&c&&(_=!1,o(),a==="auto"&&M()&&u!=="hls"&&!m&&y("hls",{time:n.currentTime,shouldPlay:!n.paused})),r.fast.ready&&(T=!1),r.hd.ready&&(E=!1),r.hls.ready&&(_=!1),!T&&!E&&!_&&(clearInterval(D),D=null)}finally{V=!1}}},ke))}async function h(e){if(!e||!e.length)return;e.includes("fast")&&(T=!0),e.includes("hd")&&(E=!0),e.includes("hls")&&(_=!0),o();const t=await le({prepareTargets:e});t&&se(t),Je()}function Ie(){if(a!=="auto"||!b||u!=="hd"||m||n.paused)return;S&&clearTimeout(S);const t=Date.now()-(z||0)<6e3?De:Fe;S=setTimeout(()=>{a==="auto"&&u==="hd"&&(m||n.paused||(Te(),y(H("fast",{avoid:"hd"}),{time:n.currentTime,shouldPlay:!0})))},t)}function Ke(){a!=="auto"||!b||w||I||n.seeking||u==="hd"||!r.hd.ready||A&&Date.now()<A||m||n.paused||y("hd",{time:n.currentTime,shouldPlay:!0})}function Xe(){ie(),o(),le().then(e=>{e&&se(e),a==="auto"&&M()&&!r.hls.ready&&h(["hls"]),a==="auto"&&!r.fast.ready?h(["fast"]):a==="hd"&&!r.hd.ready?h(["hd"]):a==="fast"&&!r.fast.ready&&h(["fast"]);const t=ae();y(H(t),{time:0,shouldPlay:!1})})}function Ge(){const e=R.indexOf(a);a=R[(e+1)%R.length];const i=n.currentTime,s=!n.paused,l=ae();(a==="auto"||a==="hd")&&!r.hd.ready&&h(["hd"]),a==="auto"&&!r.fast.ready&&h(["fast"]),a==="auto"&&M()&&!r.hls.ready&&h(["hls"]),a==="fast"&&!r.fast.ready&&h(["fast"]),y(H(l),{time:i,shouldPlay:s})}O&&(O.onclick=()=>Ge()),ce&&(ce.onclick=()=>{const e=n.currentTime,t=!n.paused;y(u||H(ae()),{time:e,shouldPlay:t,cacheBust:!0})}),n.addEventListener("play",()=>{a==="auto"&&M()&&!r.hls.ready&&!_&&h(["hls"]),a==="auto"&&!r.fast.ready&&!T&&h(["fast"]),(a==="hd"||a==="auto"&&!w)&&!r.hd.ready&&!E&&h(["hd"]),a==="fast"&&!r.fast.ready&&!T&&h(["fast"])}),n.addEventListener("playing",()=>{S&&clearTimeout(S),S=null,u==="hd"&&Re(),a==="auto"&&re(ee),o()}),n.addEventListener("seeking",()=>{P(),m||we(),o()}),n.addEventListener("seeked",()=>{we({allowFastSwitch:!1}),o()}),n.addEventListener("waiting",()=>{P(),Ie(),o()}),n.addEventListener("stalled",()=>{P(),Ie(),o()}),n.addEventListener("progress",o),n.addEventListener("timeupdate",o),n.addEventListener("pause",()=>{P(),o()}),n.addEventListener("error",()=>{P(),!(a==="auto"&&u==="hd")&&B("Could not load video","Try refreshing the page. If it keeps failing, go back to the gallery.")}),window.addEventListener("beforeunload",()=>qe()),Xe()})();
//# sourceMappingURL=video-player.min.js.map
