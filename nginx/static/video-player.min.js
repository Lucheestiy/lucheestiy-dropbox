(function(){"use strict";function W(t){return String(t||"").split("/").map(n=>encodeURIComponent(n)).join("/")}function It(t){if(t==null||(t=String(t),t.startsWith("/")||t.startsWith("\\"))||t.includes("\\"))return null;const n=t.split("/").filter(Boolean);return!n.length||n.some(a=>a==="..")?null:n.join("/")}function x(t,n){document.getElementById("errorTitle").textContent=t||"Error",document.getElementById("errorMessage").textContent=n||"",document.getElementById("error").classList.add("show")}const q=new URLSearchParams(window.location.search),w=(q.get("share")||"").trim(),At=(q.get("file")||"").trim();if(!/^[A-Za-z0-9_-]{1,64}$/.test(w)){x("Invalid link","Missing or invalid share hash.");return}const D=It(At);if(!D){x("Invalid link","Missing or invalid file path.");return}const Q=D.split("/").pop()||D;document.title=Q+" - Dropbox",document.getElementById("fileName").textContent=Q;const N=document.getElementById("fileSub");N&&(N.textContent=w);const at=`/api/share/${w}/video-sources/${W(D)}`,Y=`/api/public/dl/${w}/${W(D)}?inline=true`,Mt=`/api/share/${w}/file/${W(D)}?download=1`,wt=`/gallery/${w}`,e=document.getElementById("video"),st=document.getElementById("bufferText"),ot=document.getElementById("timeText"),J=document.getElementById("bufferFill"),vt=document.getElementById("backLink"),lt=document.getElementById("downloadLink"),ut=document.getElementById("openLink"),$=document.getElementById("qualityBtn"),ft=document.getElementById("reloadBtn"),dt=!!(st&&ot&&J);vt.href=wt,lt.href=Mt,lt.download=Q,ut.href=Y;const O=["auto","hd","fast"],ct={auto:"Auto",hd:"HD",fast:"Fast"};let i=(q.get("quality")||"auto").trim().toLowerCase();O.includes(i)||(i="auto");const r={original:{url:Y,size:null},fast:{url:null,ready:!1,size:null},hd:{url:null,ready:!1,size:null},hls:{url:null,ready:!1,variants:[]}};let u=null,m=!1,T=null,k=null,R=0,_=null,K=0,X=!1,ht=0,U=0,v=0,I=!1,z=null,S=null,A=!1,L=!1,B=!1,b=null,j=null,mt=0,M=!1;const Pt=3500,Ft=8e3,Dt=15e3,_t=300*1e3,Bt=3,Ht=5e3,G=1200,xt=2e3,kt=600*1e3,yt=800,Ut=navigator.userAgent||"",E=!(/iPad|iPhone|iPod/i.test(Ut)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1);function Ct(){return!!e.canPlayType&&e.canPlayType("application/vnd.apple.mpegurl")}function pt(){return!!window.Hls&&Hls.isSupported()}function P(){return Ct()||pt()}function Z(){if(b){try{b.destroy()}catch{}b=null}}function V(t){if(!Number.isFinite(t)||t<0)return"--:--";const n=Math.floor(t),a=Math.floor(n/3600),s=Math.floor(n%3600/60),o=n%60;return a>0?`${a}:${String(s).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${s}:${String(o).padStart(2,"0")}`}function F(){z&&(clearTimeout(z),z=null)}function Nt(){const t=Math.max(0,U-1),n=Dt*Math.pow(2,t);return Math.min(_t,n)}function gt(){ht=Date.now(),U=Math.min(10,U+1),v=ht+Nt(),I=U>=Bt,F(),S&&(clearTimeout(S),S=null)}function $t(){U=0,v=0,I=!1}function Ot(){F(),z=setTimeout(()=>{u==="hd"&&(e.paused||e.seeking||e.error||($t(),l()))},Ht)}function tt(t){i==="auto"&&E&&(I||(S&&clearTimeout(S),S=setTimeout(()=>{S=null,Jt()},Math.max(0,t||0))))}function St(t){return t==="hls"?"Adaptive":t==="hd"?"HD":t==="fast"?"Fast":"Original"}function Rt(t){const n=r[t]&&r[t].url;ut.href=n||r.original.url||Y}function C(){const t=ct[i]||"Auto",n=u?St(u):"";$&&($.textContent=i==="auto"&&n?`${t} (${n})`:t),N&&(N.textContent=w),Rt(u||"original")}function zt(){if(e.error)return"Error";if(e.seeking)return"Seeking";const t=Date.now()-(R||0);return e.readyState===0&&t>2e3?u==="fast"?"Loading fast preview\u2026":u==="hd"?"Loading HD\u2026":"Loading original\u2026":!e.paused&&e.readyState<3?"Buffering":e.paused?e.currentTime>0?"Paused":e.readyState>=2?"Ready":"Loading":"Playing"}function jt(){const t=Number.isFinite(e.duration)?e.duration:null,n=Number.isFinite(e.currentTime)?e.currentTime:0,a=[];try{const c=e.buffered;for(let f=0;f<c.length;f++){const g=c.start(f),p=c.end(f);Number.isFinite(g)&&Number.isFinite(p)&&p>g&&a.push([g,p])}}catch{}let s=0;for(const[c,f]of a)s+=f-c;let o=0;for(const[c,f]of a)if(n>=c&&n<=f){o=Math.max(0,f-n);break}const d=t&&t>0?Math.max(0,Math.min(1,s/t)):null;return{dur:t,ct:n,pct:d,ahead:o}}function l(){if(!dt)return;const t=zt(),n=jt();ot.textContent=n.dur?`${V(n.ct)} / ${V(n.dur)}`:V(n.ct);const a=ct[i]||"Auto",s=u?St(u):"";let o=s?`${a} \u2022 ${s} \u2022 ${t}`:`${a} \u2022 ${t}`;if(n.pct!=null){const d=Math.round(n.pct*100);o+=` \u2022 Buffered ${d}%`,n.ahead>0&&(o+=` \u2022 Ahead ${Math.round(n.ahead)}s`),J.style.width=`${Math.max(0,Math.min(100,n.pct*100)).toFixed(1)}%`}else J.style.width="0%";if((i==="auto"||i==="hd")&&!r.hd.ready&&A&&(o+=" \u2022 Preparing HD\u2026"),(i==="auto"||i==="fast")&&!r.fast.ready&&L&&(o+=" \u2022 Preparing Fast\u2026"),i==="auto"&&P()&&!r.hls.ready&&B&&(o+=" \u2022 Preparing Adaptive\u2026"),i==="auto"&&!E&&(o+=" \u2022 iOS: Auto=HD"),i==="auto"&&r.hd.ready&&u!=="hd"){if(I)o+=" \u2022 HD off (tap HD)";else if(v&&Date.now()<v){const d=Math.max(1,Math.ceil((v-Date.now())/1e3));o+=` \u2022 HD retry in ${d}s`}}st.textContent=o}function et(){dt&&(k||(k=setInterval(l,500)))}function Wt(){k&&(clearInterval(k),k=null)}function qt(t,n){if(!n)return t;const a=t.includes("?")?"&":"?";return t+a+"v="+Date.now()}function Tt(t,n){const a=r[t]&&r[t].url;return a?qt(a,n):null}function H(t,n){const a=n||{},s=a.avoid?String(a.avoid):"";return t==="hls"?s!=="hls"&&r.hls.ready&&P()?"hls":s!=="hd"&&r.hd.ready?"hd":s!=="fast"&&r.fast.ready?"fast":"original":t==="hd"?s!=="hd"&&r.hd.ready?"hd":s!=="fast"&&r.fast.ready?"fast":"original":t==="fast"?s!=="fast"&&r.fast.ready?"fast":s!=="hd"&&r.hd.ready?"hd":"original":s!=="hd"&&r.hd.ready?"hd":s!=="fast"&&r.fast.ready?"fast":"original"}function nt(){return i==="fast"?"fast":i==="hd"?"hd":P()&&r.hls.ready?"hls":E&&(I||e.paused||M||e.seeking)?"fast":"hd"}function Lt(t){const a=(t||{}).allowFastSwitch!==!1;mt=Date.now(),M||(M=!0,S&&(clearTimeout(S),S=null),i==="auto"&&(!r.fast.ready&&!L&&h(["fast"]),E&&a&&r.fast.ready&&u!=="fast"&&!m&&y("fast",{time:e.currentTime,shouldPlay:!e.paused})),l()),j&&clearTimeout(j),j=setTimeout(()=>{Date.now()-mt<yt||(j=null,M&&(M=!1,l(),i==="auto"&&!e.paused&&(E&&!I&&!r.hd.ready&&!A&&h(["hd"]),tt(G))))},yt+25)}function bt(){T&&clearTimeout(T),T=null}function Qt(t){const n=t||{},a=Number.isFinite(n.time)?Math.max(0,n.time):null,s=!!n.shouldPlay,o=!!n.cacheBust,d=Tt("hls",o);if(!d){x("Could not load video","Missing adaptive stream.");return}m=!0,bt(),u="hls",R=Date.now(),C(),e.pause(),Z(),e.removeAttribute("src"),e.load(),l();function c(){m=!1,C()}function f(){try{if(a!=null){const g=Number.isFinite(e.duration)?e.duration:null;e.currentTime=g?Math.min(a,Math.max(0,g-.25)):a}}catch{}}pt()?(b=new Hls({maxBufferLength:60,backBufferLength:60}),b.attachMedia(e),b.on(Hls.Events.MEDIA_ATTACHED,()=>{b.loadSource(d)}),b.on(Hls.Events.MANIFEST_PARSED,()=>{f(),s&&e.play().catch(()=>{}),c()}),b.on(Hls.Events.ERROR,(g,p)=>{p&&p.fatal&&(Z(),c(),i==="auto"&&y(H("fast",{avoid:"hls"}),{time:a,shouldPlay:s}))})):(e.addEventListener("loadedmetadata",()=>{f(),s&&e.play().catch(()=>{}),c()},{once:!0}),e.src=d,e.load()),et(),l()}function y(t,n){if(t==="hls"){Qt(n);return}const a=n||{},s=Number.isFinite(a.time)?Math.max(0,a.time):null,o=!!a.shouldPlay,d=!!a.cacheBust,c=Tt(t,d);if(!c){x("Could not load video","Missing source URL.");return}m=!0,bt(),u=t,R=Date.now(),C();const f=e.currentTime||0;function g(){m=!1,C()}e.pause(),Z(),e.removeAttribute("src"),e.load(),l(),e.addEventListener("loadedmetadata",()=>{try{if(s!=null){const p=Number.isFinite(e.duration)?e.duration:null;e.currentTime=p?Math.min(s,Math.max(0,p-.25)):s}}catch{}o&&e.play().catch(()=>{}),g()},{once:!0}),e.addEventListener("error",()=>{if(g(),i==="auto"&&t==="hd"){gt();const p=Number.isFinite(s)?s:f;y(H("fast",{avoid:"hd"}),{time:p,shouldPlay:o})}},{once:!0}),e.src=c,e.load(),et(),l()}async function rt(t){const n=t||{},a=new AbortController,s=setTimeout(()=>a.abort(),8e3);try{const o=at+(at.includes("?")?"&":"?")+"t="+Date.now();let d;return n.prepareTargets&&n.prepareTargets.length?d=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prepare:n.prepareTargets}),signal:a.signal,cache:"no-store"}):d=await fetch(o,{signal:a.signal,cache:"no-store"}),d.ok?await d.json():null}catch{return null}finally{clearTimeout(s)}}function it(t){if(!(!t||typeof t!="object")){if(t.original&&typeof t.original=="object"){typeof t.original.url=="string"&&t.original.url&&(r.original.url=t.original.url);const n=Number(t.original.size);Number.isFinite(n)&&n>0&&(r.original.size=Math.floor(n))}if(t.fast&&typeof t.fast=="object"){typeof t.fast.url=="string"&&t.fast.url&&(r.fast.url=t.fast.url),typeof t.fast.ready=="boolean"&&(r.fast.ready=t.fast.ready);const n=Number(t.fast.size);r.fast.size=Number.isFinite(n)&&n>0?Math.floor(n):null}if(t.hd&&typeof t.hd=="object"){typeof t.hd.url=="string"&&t.hd.url&&(r.hd.url=t.hd.url),typeof t.hd.ready=="boolean"&&(r.hd.ready=t.hd.ready);const n=Number(t.hd.size);r.hd.size=Number.isFinite(n)&&n>0?Math.floor(n):null}t.hls&&typeof t.hls=="object"&&(typeof t.hls.url=="string"&&t.hls.url&&(r.hls.url=t.hls.url),typeof t.hls.ready=="boolean"&&(r.hls.ready=t.hls.ready),Array.isArray(t.hls.variants)&&(r.hls.variants=t.hls.variants)),C(),l()}}function Yt(){_||(K=Date.now(),_=setInterval(async()=>{if(K&&Date.now()-K>kt){clearInterval(_),_=null,L=!1,A=!1,l();return}if(!X){X=!0;try{const t=r.fast.ready,n=r.hd.ready,a=r.hls.ready,s=await rt();s&&it(s);const o=r.fast.ready,d=r.hd.ready,c=r.hls.ready;if(!t&&o){L=!1,l();const f=!e.paused;m||(i==="fast"&&u!=="fast"?y("fast",{time:e.currentTime,shouldPlay:f}):i==="auto"&&E&&(M||e.seeking||e.paused)&&u!=="fast"&&y("fast",{time:e.currentTime,shouldPlay:f}))}if(!n&&d&&(A=!1,l(),!m))if(i==="hd"){const f=()=>{if(!m&&!(i!=="hd"||u==="hd")){if(M||e.seeking){setTimeout(f,500);return}y("hd",{time:e.currentTime,shouldPlay:!e.paused})}};f()}else i==="auto"&&E&&!e.paused&&tt(G);!a&&c&&(B=!1,l(),i==="auto"&&P()&&u!=="hls"&&!m&&y("hls",{time:e.currentTime,shouldPlay:!e.paused})),r.fast.ready&&(L=!1),r.hd.ready&&(A=!1),r.hls.ready&&(B=!1),!L&&!A&&!B&&(clearInterval(_),_=null)}finally{X=!1}}},xt))}async function h(t){if(!t||!t.length)return;t.includes("fast")&&(L=!0),t.includes("hd")&&(A=!0),t.includes("hls")&&(B=!0),l();const n=await rt({prepareTargets:t});n&&it(n),Yt()}function Et(){if(i!=="auto"||!E||u!=="hd"||m||e.paused)return;T&&clearTimeout(T);const n=Date.now()-(R||0)<6e3?Ft:Pt;T=setTimeout(()=>{i==="auto"&&u==="hd"&&(m||e.paused||(gt(),y(H("fast",{avoid:"hd"}),{time:e.currentTime,shouldPlay:!0})))},n)}function Jt(){i!=="auto"||!E||I||M||e.seeking||u==="hd"||!r.hd.ready||v&&Date.now()<v||m||e.paused||y("hd",{time:e.currentTime,shouldPlay:!0})}function Kt(){et(),l(),rt().then(t=>{t&&it(t),i==="auto"&&P()&&!r.hls.ready&&h(["hls"]),i==="auto"&&!r.fast.ready?h(["fast"]):i==="hd"&&!r.hd.ready?h(["hd"]):i==="fast"&&!r.fast.ready&&h(["fast"]);const n=nt();y(H(n),{time:0,shouldPlay:!1})})}function Xt(){const t=O.indexOf(i);i=O[(t+1)%O.length];const a=e.currentTime,s=!e.paused,o=nt();(i==="auto"||i==="hd")&&!r.hd.ready&&h(["hd"]),i==="auto"&&!r.fast.ready&&h(["fast"]),i==="auto"&&P()&&!r.hls.ready&&h(["hls"]),i==="fast"&&!r.fast.ready&&h(["fast"]),y(H(o),{time:a,shouldPlay:s})}$&&($.onclick=()=>Xt()),ft&&(ft.onclick=()=>{const t=e.currentTime,n=!e.paused;y(u||H(nt()),{time:t,shouldPlay:n,cacheBust:!0})}),e.addEventListener("play",()=>{i==="auto"&&P()&&!r.hls.ready&&!B&&h(["hls"]),i==="auto"&&!r.fast.ready&&!L&&h(["fast"]),(i==="hd"||i==="auto"&&!I)&&!r.hd.ready&&!A&&h(["hd"]),i==="fast"&&!r.fast.ready&&!L&&h(["fast"])}),e.addEventListener("playing",()=>{T&&clearTimeout(T),T=null,u==="hd"&&Ot(),i==="auto"&&tt(G),l()}),e.addEventListener("seeking",()=>{F(),m||Lt(),l()}),e.addEventListener("seeked",()=>{Lt({allowFastSwitch:!1}),l()}),e.addEventListener("waiting",()=>{F(),Et(),l()}),e.addEventListener("stalled",()=>{F(),Et(),l()}),e.addEventListener("progress",l),e.addEventListener("timeupdate",l),e.addEventListener("pause",()=>{F(),l()}),e.addEventListener("error",()=>{F(),!(i==="auto"&&u==="hd")&&x("Could not load video","Try refreshing the page. If it keeps failing, go back to the gallery.")}),window.addEventListener("beforeunload",()=>Wt()),Kt()})();
