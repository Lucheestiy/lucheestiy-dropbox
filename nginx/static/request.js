(function(){const T=String(window.location.pathname||"").match(/\/request\/([^/]+)/),w=T?T[1]:"",k=document.getElementById("subtitle"),_=document.getElementById("status"),H=document.getElementById("expires-note"),J=document.getElementById("password-block"),f=document.getElementById("password-input"),u=document.getElementById("dropzone"),x=document.getElementById("file-input"),h=document.getElementById("upload-btn"),z=document.getElementById("file-list"),M=document.getElementById("captcha-block"),I=document.getElementById("captcha-widget"),j=u==null?void 0:u.querySelector(".hint");let q=!1,E=!1,d=!1,m="",c="",F=!1,g=[],b=0,R=!1;const v=[];let S=0;const V=8*1024*1024,G=32*1024*1024;function a(e,t){_.textContent=e||"",_.className="status"+(t?" "+t:"")}function X(e){if(!e&&e!==0)return"";const t=["B","KB","MB","GB","TB"];let r=0,o=e;for(;o>=1024&&r<t.length-1;)o/=1024,r+=1;return o.toFixed(o>=10||r===0?0:1)+" "+t[r]}function Q(e){if(!e)return"";const t=Math.ceil(e/3600);if(t<24)return"Expires in "+t+" hour"+(t===1?"":"s");const r=Math.ceil(t/24);return"Expires in "+r+" day"+(r===1?"":"s")}function W(e){return!e||!e.length?[]:e.map(t=>String(t||"").trim().replace(/^\./,"").toLowerCase()).filter(t=>t)}function Y(e){const t=String(e||""),r=t.lastIndexOf(".");return r<=0||r===t.length-1?"":t.slice(r+1).toLowerCase()}function Z(e){if(!g.length)return!0;const t=Y(e);return t?g.indexOf(t)>=0:!1}function y(e){if(!e)return"";let t=String(e||"").replace(/\\/g,"/");if(t.charAt(0)==="/")return"";const r=t.split("/").filter(o=>o);if(!r.length)return"";for(let o=0;o<r.length;o+=1){const s=r[o];if(s==="."||s===".."||/[\x00-\x1f\x7f]/.test(s))return""}return r.join("/")}function $(){if(!j)return;const e="Multiple files supported. Keep the tab open until upload completes.",t=[];g.length&&t.push("Allowed types: "+g.join(", ")+"."),b&&t.push("Max size: "+X(b)+"."),j.textContent=t.length?e+" "+t.join(" "):e}function ee(){if(!x)return;if(!g.length){x.removeAttribute("accept");return}const e=g.map(t=>"."+t).join(",");x.setAttribute("accept",e)}function A(e){const t=document.createElement("li");return t.className="file-item",t.innerHTML='<div class="file-row"><div class="file-name"></div><div class="file-size"></div></div><div class="file-row"><div class="file-status"></div><div class="file-progress"></div></div><div class="progress-bar"><span></span></div>',t.querySelector(".file-name").textContent=e.name,t.querySelector(".file-size").textContent=X(e.size),e.el=t,l(e),t}function l(e){if(!e.el)return;const t=e.status||"queued",r=t==="uploading"?"Uploading":t==="done"?"Complete":t==="error"?"Failed":"Queued";e.el.querySelector(".file-status").textContent=r,e.el.querySelector(".file-progress").textContent=t==="done"?"100%":(e.progress||0)+"%",e.el.querySelector(".progress-bar span").style.width=(e.progress||0)+"%"}function p(){if(!v.length||R){h.disabled=!0;return}if(q&&!f.value){h.disabled=!0;return}if(d&&!c){h.disabled=!0;return}h.disabled=!1}function C(e,t,r){E=!!t,r&&(m=r),d=!!e&&E&&!!m,d?(M.classList.add("show"),te()):(M.classList.remove("show"),c=""),p()}function te(){if(!E||!m||F)return;if(window.turnstile&&typeof window.turnstile.render=="function"){O();return}if(document.getElementById("turnstile-script"))return;const e=document.createElement("script");e.id="turnstile-script",e.src="https://challenges.cloudflare.com/turnstile/v0/api.js",e.async=!0,e.defer=!0,e.onload=O,document.head.appendChild(e)}function O(){!window.turnstile||!I||!m||(I.innerHTML="",F=!0,window.turnstile.render(I,{sitekey:m,callback:e=>{c=e||"",p()},"expired-callback":()=>{c="",p()},"error-callback":()=>{c="",p()}}))}function D(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function L(e,t){S+=1;const r={name:(e==null?void 0:e.name)||"Unknown file",size:(e==null?void 0:e.size)||0,status:"error",progress:0,el:null};z.appendChild(A(r)),a(t||"File rejected.","error")}function N(e){const t=Array.prototype.slice.call(e||[]);t.length&&(t.forEach(r=>{const o=y(r.webkitRelativePath||r.name);if(!o){L(r,"Invalid file path.");return}if(b&&r.size>b){L(r,"File exceeds the maximum allowed size.");return}if(!Z(o)){L(r,"Unsupported file type.");return}S+=1;const s={id:S,file:r,name:r.name,size:r.size,relPath:o,status:"queued",progress:0,el:null};v.push(s),z.appendChild(A(s))}),a("Ready to upload "+t.length+" file"+(t.length===1?"":"s")+".",""),p())}function re(e){return new Promise(t=>{e.status="uploading",e.progress=0,l(e);const r=new XMLHttpRequest;r.open("POST","/api/droppr/requests/"+encodeURIComponent(w)+"/upload"),r.timeout=0,q&&f.value&&r.setRequestHeader("X-Request-Password",encodeURIComponent(f.value)),d&&c&&r.setRequestHeader("X-Captcha-Token",c),r.upload.onprogress=s=>{s.lengthComputable&&(e.progress=Math.max(1,Math.floor(s.loaded/s.total*100)),l(e))},r.onerror=()=>{e.status="error",l(e),a("Upload failed. Please try again.","error"),t()},r.onload=()=>{const s=D(r.responseText||"");if(s&&typeof s=="object"&&C(!!s.captcha_required,!!s.captcha_enabled,s.captcha_site_key||""),r.status>=200&&r.status<300){e.status="done",e.progress=100,l(e),d&&C(!1,E,m),t();return}r.status===401?a((s==null?void 0:s.error)||"Password required or incorrect.","error"):r.status===403?a((s==null?void 0:s.error)||"Verification required.","error"):r.status===410?a("This request link has expired.","error"):r.status===429?a((s==null?void 0:s.error)||"Too many attempts. Try again later.","error"):r.status===400||r.status===413||r.status===415?a((s==null?void 0:s.error)||"Upload rejected.","error"):a((s==null?void 0:s.error)||"Upload failed ("+r.status+").","error"),e.status="error",l(e),t()};const o=new FormData;o.append("file",e.file,e.file.name),e.relPath&&e.relPath!==e.file.name&&o.append("relative_path",e.relPath),r.send(o)})}function se(e){return new Promise(t=>{e.status="uploading",e.progress=0,l(e);const r=e.file.size;let o=0,s=e.uploadId||"",K=0;function U(){if(o>=r){e.status="done",e.progress=100,l(e),t();return}const B=Math.min(o+V,r),ae=e.file.slice(o,B),i=new XMLHttpRequest;i.open("POST","/api/droppr/requests/"+encodeURIComponent(w)+"/upload-chunk"),i.timeout=0,i.setRequestHeader("Content-Range","bytes "+o+"-"+(B-1)+"/"+r),i.setRequestHeader("X-Upload-Offset",String(o)),i.setRequestHeader("X-Upload-Length",String(r)),i.setRequestHeader("X-Upload-Path",e.relPath||e.file.name),i.setRequestHeader("Content-Type",e.file.type||"application/octet-stream"),s&&i.setRequestHeader("X-Upload-Id",s),q&&f.value&&i.setRequestHeader("X-Request-Password",encodeURIComponent(f.value)),d&&c&&i.setRequestHeader("X-Captcha-Token",c),i.upload.onprogress=n=>{if(!n.lengthComputable)return;const P=Math.floor((o+n.loaded)/r*100);e.progress=Math.max(1,Math.min(99,P)),l(e)},i.onerror=()=>{e.status="error",l(e),a("Upload failed. Please try again.","error"),t()},i.onload=()=>{const n=D(i.responseText||"");if(n&&typeof n=="object"&&C(!!n.captcha_required,!!n.captcha_enabled,n.captcha_site_key||""),i.status>=200&&i.status<300){if(s=(n==null?void 0:n.upload_id)||s,e.uploadId=s,n!=null&&n.complete){e.status="done",e.progress=100,l(e),d&&C(!1,E,m),t();return}const P=typeof(n==null?void 0:n.offset)=="number"?n.offset:B;o=Math.max(o,P),e.progress=Math.max(e.progress,Math.floor(o/r*100)),l(e),U();return}if(i.status===409&&typeof(n==null?void 0:n.offset)=="number"&&K<2){K+=1,o=n.offset,U();return}i.status===401?a((n==null?void 0:n.error)||"Password required or incorrect.","error"):i.status===403?a((n==null?void 0:n.error)||"Verification required.","error"):i.status===410?a("This request link has expired.","error"):i.status===429?a((n==null?void 0:n.error)||"Too many attempts. Try again later.","error"):i.status===400||i.status===413||i.status===415?a((n==null?void 0:n.error)||"Upload rejected.","error"):a((n==null?void 0:n.error)||"Upload failed ("+i.status+").","error"),e.status="error",l(e),t()},i.send(ae)}U()})}function ne(){if(R||!v.length)return;if(q&&!f.value){a("Password required to upload.","error");return}if(d&&!c){a("Verification required to upload.","error");return}R=!0,h.disabled=!0,a("Uploading files...","");let e=Promise.resolve();v.forEach(t=>{t.status!=="done"&&(e=e.then(()=>t.file.size>=G?se(t):re(t)))}),e.then(()=>{R=!1,v.filter(r=>r.status==="error").length?a("Some files failed. Fix and click Upload again to retry.","error"):a("All uploads complete. You can close this tab.","success"),p()})}function oe(){u.addEventListener("click",()=>{w&&x.click()}),x.addEventListener("change",e=>{const t=e.target;N(t.files||[]),x.value=""}),u.addEventListener("dragover",e=>{e.preventDefault(),u.classList.add("drag")}),u.addEventListener("dragleave",()=>{u.classList.remove("drag")}),u.addEventListener("drop",e=>{var t;e.preventDefault(),u.classList.remove("drag"),(t=e.dataTransfer)!=null&&t.files&&N(e.dataTransfer.files)})}function ie(){if(!w){a("Invalid request link.","error"),k.textContent="This link is missing its request ID.",u.classList.add("disabled");return}fetch("/api/droppr/requests/"+encodeURIComponent(w)).then(e=>e.text().then(t=>{let r=null;if(t)try{r=JSON.parse(t)}catch{r=null}if(!e.ok){const o=(r==null?void 0:r.error)||"Request unavailable";throw new Error(o)}return r||{}})).then(e=>{q=!!e.requires_password,C(!!e.captcha_required,!!e.captcha_enabled,e.captcha_site_key||""),g=W(e.allowed_extensions||[]),b=e.max_file_size||0,$(),ee();const t=e.folder||"Uploads";k.textContent="Uploads go directly to the folder: "+t+".",q?(J.classList.add("show"),a("Password required to upload.","")):a("Ready to upload files.",""),e.expires_in?H.textContent=Q(e.expires_in):H.textContent="No expiration set.",p()}).catch(e=>{a(e.message||String(e),"error"),k.textContent="This request link is not available.",h.disabled=!0})}h.addEventListener("click",ne),f.addEventListener("input",p),oe(),ie()})();
//# sourceMappingURL=request.js.map
