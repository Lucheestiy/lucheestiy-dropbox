(function () {
  const S = {
      STUCK_TIMEOUT: 6e3,
      SEEK_TIMEOUT: 8e3,
      MAX_PRELOAD_CACHE: 15,
      SLIDESHOW_INTERVAL: 4e3,
      VIRTUAL_SCROLL_THRESHOLD: 100,
      VIRTUAL_CHUNK_SIZE: 60,
      VIRTUAL_PREFETCH_PX: 1200,
    },
    E = window.DROPPR_CONFIG || {},
    pe = [240, 320, 480, 640, 800],
    J = Ee(E.previewWidths),
    Q = String(E.previewFormat || "auto")
      .trim()
      .toLowerCase(),
    ve =
      typeof E.previewSizes == "string" && E.previewSizes.trim()
        ? E.previewSizes.trim()
        : "(max-width: 600px) 100vw, (max-width: 900px) 50vw, (max-width: 1200px) 33vw, 25vw",
    ge = typeof E.assetBaseUrl == "string" ? E.assetBaseUrl.replace(/\/+$/, "") : "",
    ye = navigator.userAgent || "",
    we =
      /iPad|iPhone|iPod/.test(ye) ||
      (navigator.platform === "MacIntel" && (navigator.maxTouchPoints || 0) > 1),
    e = {
      files: [],
      filteredFiles: [],
      currentIndex: 0,
      shareHash: null,
      filter: "all",
      sort: "type_asc",
      layout: "grid",
      showDetails: !0,
      search: "",
      isSlideshow: !1,
      slideshowInterval: null,
      isZoomed: !1,
      zoomScale: 1,
      immersiveTimer: null,
      touchStartX: null,
      pinchStartDistance: null,
      pinchStartScale: 1,
      isPulling: !1,
      isRefreshing: !1,
      isOffline: !navigator.onLine,
      videoTimers: { stuck: null, wait: null, seek: null, stall: null },
      videoStatusInterval: null,
      scrollLockY: 0,
      videoMetaCache: {},
      videoMetaInFlight: {},
      virtual: { enabled: !1, rendered: 0, sentinel: null, observer: null, inFlight: !1 },
    },
    n = {};
  let D = null;
  function Se() {
    ((n.grid = document.getElementById("galleryGrid")),
      (n.loading = document.getElementById("loading")),
      (n.empty = document.getElementById("emptyState")),
      (n.emptyTitle = document.getElementById("emptyTitle")),
      (n.emptyMessage = document.getElementById("emptyMessage")),
      (n.error = document.getElementById("errorState")),
      (n.errorTitle = document.getElementById("errorTitle")),
      (n.errorMessage = document.getElementById("errorMessage")),
      (n.search = document.getElementById("searchInput")),
      (n.sort = document.getElementById("sortSelect")),
      (n.filters = document.querySelectorAll(".filter-btn")),
      (n.modal = document.getElementById("modal")),
      (n.modalContent = document.getElementById("modalContent")),
      (n.modalTitle = document.getElementById("modalTitle")),
      (n.modalMeta = document.getElementById("modalMeta")),
      (n.downloadAll = document.getElementById("downloadAllBtn")),
      (n.copyLink = document.getElementById("copyLinkBtn")),
      (n.streamBtn = document.getElementById("streamBtn")),
      (n.refresh = document.getElementById("refreshBtn")),
      (n.details = document.getElementById("detailsBtn")),
      (n.backToTop = document.getElementById("backToTop")),
      (n.viewOriginal = document.getElementById("viewOriginalBtn")),
      (n.download = document.getElementById("downloadBtn")),
      (n.videoOverlay = document.getElementById("videoOverlay")),
      (n.overlayMessage = document.getElementById("overlayMessage")),
      (n.speedBtn = document.getElementById("speedBtn")),
      (n.resetVideoBtn = document.getElementById("resetVideoBtn")),
      (n.helpOverlay = document.getElementById("helpOverlay")),
      (n.offlineBanner = document.getElementById("offlineBanner")),
      (n.pullToRefresh = document.getElementById("pullToRefresh")),
      (n.themeToggle = document.getElementById("themeToggle")));
  }
  const ee = "droppr_gallery_prefs";
  function P() {
    try {
      return JSON.parse(localStorage.getItem(ee) || "{}");
    } catch {
      return {};
    }
  }
  function C(t) {
    try {
      localStorage.setItem(ee, JSON.stringify({ ...P(), ...t }));
    } catch {}
  }
  function te() {
    return P().theme || "dark";
  }
  function ne(t) {
    const i = t === "dark";
    (document.documentElement.setAttribute("data-theme", t),
      n.themeToggle &&
        ((n.themeToggle.textContent = i ? "üåô" : "‚òÄÔ∏è"),
        (n.themeToggle.title = i ? "Switch to light theme" : "Switch to dark theme")),
      C({ theme: t }));
  }
  function Ie() {
    const t = te();
    ne(t === "dark" ? "light" : "dark");
  }
  function Te() {
    const t = te();
    (ne(t), n.themeToggle && n.themeToggle.addEventListener("click", Ie));
  }
  function L(t) {
    return String(t || "")
      .split("/")
      .map((i) => encodeURIComponent(i))
      .join("/");
  }
  function Ee(t) {
    const o = (Array.isArray(t) ? t : [])
      .map((r) => Number(r))
      .filter((r) => Number.isFinite(r) && r > 0);
    if (o.length === 0) return pe.slice();
    o.sort((r, a) => r - a);
    const l = [];
    return (
      o.forEach((r) => {
        l[l.length - 1] !== r && l.push(r);
      }),
      l
    );
  }
  function V(t, i, o) {
    let l = `/api/share/${e.shareHash}/preview/${L(t)}?v=${i || 0}`;
    return (o && (l += `&w=${o}`), Q && (l += `&format=${encodeURIComponent(Q)}`), l);
  }
  function Le(t, i) {
    return J.length ? J.map((o) => `${V(t, i, o)} ${o}w`).join(", ") : "";
  }
  function I(t) {
    if (!t) return "0 B";
    const i = 1e3,
      o = ["B", "KB", "MB", "GB"],
      l = Math.floor(Math.log(t) / Math.log(i));
    return l <= 0 ? Math.round(t) + " B" : (t / Math.pow(i, l)).toFixed(1) + " " + o[l];
  }
  function Be(t) {
    const i = Number(t);
    if (!Number.isFinite(i) || i <= 0) return "";
    const o = Math.floor(i),
      l = Math.floor(o / 3600),
      r = Math.floor((o % 3600) / 60),
      a = o % 60;
    return l > 0
      ? `${l}:${String(r).padStart(2, "0")}:${String(a).padStart(2, "0")}`
      : `${r}:${String(a).padStart(2, "0")}`;
  }
  function be(t) {
    if (t == null) return "";
    const i = parseInt(String(t), 10);
    if (!Number.isFinite(i) || i <= 0) return "";
    try {
      return new Date(i * 1e3).toLocaleString();
    } catch {
      return "";
    }
  }
  function ke(t, i, o) {
    return Math.min(o, Math.max(i, t));
  }
  function ie(t) {
    if (!t || t.length < 2) return null;
    const i = t[0].screenX - t[1].screenX,
      o = t[0].screenY - t[1].screenY;
    return Math.sqrt(i * i + o * o);
  }
  function oe(t) {
    var l;
    const i = (l = n.modalContent) == null ? void 0 : l.querySelector(".modal-media");
    if (!i || i.tagName !== "IMG") return;
    ((e.zoomScale = ke(t, 1, 3)),
      (e.isZoomed = e.zoomScale > 1.05),
      (i.style.transform = `scale(${e.zoomScale})`),
      i.classList.toggle("zoomable", !0));
    const o = document.getElementById("zoomBtn");
    o && (o.textContent = e.isZoomed ? "üîé" : "üîç");
  }
  function Ce(t) {
    if (!t || typeof t != "string") return;
    const i = t.replace(/\/+$/, "");
    if (
      !i ||
      i === window.location.origin ||
      document.querySelector(`link[rel="preconnect"][href="${i}"]`)
    )
      return;
    const o = document.createElement("link");
    ((o.rel = "preconnect"),
      (o.href = i),
      (o.crossOrigin = "anonymous"),
      document.head.appendChild(o));
    const l = document.createElement("link");
    ((l.rel = "dns-prefetch"), (l.href = i), document.head.appendChild(l));
  }
  function xe() {
    Ce(ge);
  }
  function Me(t) {
    const i = String(t || "").toLowerCase();
    return i === "transcode_hevc_to_h264"
      ? "Transcoded HEVC ‚Üí H.264"
      : i === "fix_video_errors_extra_streams"
        ? "Re-encoded (removed extra streams)"
        : i === "fix_video_errors_timestamp"
          ? "Re-encoded (fixed timestamps)"
          : i === "faststart"
            ? "Faststart (moov moved)"
            : i === "already_faststart"
              ? "Already faststart"
              : i === "none"
                ? "No changes"
                : t
                  ? String(t)
                  : "";
  }
  function se(t, i) {
    if (!t || typeof t != "object") {
      const m = Number(i);
      return Number.isFinite(m) && m > 0 ? I(m) : "‚Äî";
    }
    const o = t.video && typeof t.video == "object" ? t.video : {},
      l = t.audio && typeof t.audio == "object" ? t.audio : {};
    let r = null;
    Number.isFinite(Number(i)) && Number(i) > 0
      ? (r = Number(i))
      : Number.isFinite(Number(t.size)) && Number(t.size) > 0 && (r = Number(t.size));
    const a = parseInt(String(o.display_width || o.width || ""), 10),
      d = parseInt(String(o.display_height || o.height || ""), 10),
      c = !isNaN(a) && !isNaN(d) && a > 0 && d > 0 ? `${a}√ó${d}` : "",
      u = o.codec ? String(o.codec).toUpperCase() : "",
      h = l.codec ? String(l.codec).toUpperCase() : "",
      v = u ? (h ? `${u}/${h}` : u) : h || "",
      y = Be(t.duration),
      w = Number(o.fps),
      s = Number.isFinite(w) && w > 0 ? `${Math.round(w * 100) / 100}fps` : "";
    return [r ? I(r) : "", c, v, y, s].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî";
  }
  function $e() {
    n.details && (n.details.textContent = e.showDetails ? "‚Ñπ Details: On" : "‚Ñπ Details: Off");
  }
  function re(t, i = {}) {
    const o = !!t;
    ((e.showDetails = o),
      document.body.classList.toggle("show-details", o),
      $e(),
      i.skipSave || C({ show_details: o }),
      o && le());
  }
  async function _e(t) {
    const i = `/api/share/${e.shareHash}/video-meta/${L(t)}?t=${Date.now()}`,
      o = await fetch(i, { cache: "no-store" });
    return o.ok ? await o.json() : null;
  }
  function H(t, i) {
    var l;
    if (!t) return;
    if (!i || typeof i != "object") {
      ((t.innerHTML = '<span class="line">Details unavailable</span>'), (t.dataset.loaded = "1"));
      return;
    }
    const o = [];
    if (i.recorded) {
      const r = be(i.uploaded_at);
      r && o.push(`Uploaded: ${r}`);
      const a = se(i.original, i.original_size),
        d = se(i.processed, i.processed_size);
      o.push(`Original: ${a}`);
      const c = Me(i.action);
      o.push(`After: ${d}${c ? ` ‚Ä¢ ${c}` : ""}`);
    } else {
      const r = (l = i.current) != null && l.size ? I(i.current.size) : "";
      o.push(r ? `Size: ${r}` : "No video metadata recorded yet");
    }
    ((t.innerHTML = o.map((r) => `<span class="line">${r}</span>`).join("")),
      (t.dataset.loaded = "1"));
  }
  async function le() {
    if (!e.showDetails) return;
    const i = Array.from(document.querySelectorAll('.video-details[data-video-meta="1"]')).filter(
      (d) => d && !d.dataset.loaded && d.dataset.path
    );
    if (!i.length) return;
    let o = 0;
    const l = Math.min(4, i.length);
    async function r() {
      for (; o < i.length; ) {
        const d = i[o++],
          c = String(d.dataset.path || "");
        let u = c;
        try {
          u = decodeURIComponent(c);
        } catch {}
        const h = `${e.shareHash}:${u}`;
        if (e.videoMetaCache[h]) {
          H(d, e.videoMetaCache[h]);
          continue;
        }
        if (!e.videoMetaInFlight[h]) {
          e.videoMetaInFlight[h] = !0;
          try {
            const v = await _e(u);
            (v && (e.videoMetaCache[h] = v), H(d, v));
          } catch {
            H(d, null);
          } finally {
            delete e.videoMetaInFlight[h];
          }
        }
      }
    }
    const a = [];
    for (let d = 0; d < l; d++) a.push(r());
    await Promise.all(a);
  }
  function M(t) {
    const i = document.getElementById("toast"),
      o = document.getElementById("toastMessage");
    (o && (o.textContent = t),
      i == null || i.classList.add("show"),
      setTimeout(() => (i == null ? void 0 : i.classList.remove("show")), 3e3));
  }
  async function Fe(t) {
    var r;
    if ((r = navigator.clipboard) != null && r.writeText)
      try {
        return (await navigator.clipboard.writeText(t), !0);
      } catch {
        console.warn("Clipboard API failed, trying fallback");
      }
    const i = document.createElement("textarea");
    if (
      ((i.value = t),
      i.setAttribute("readonly", ""),
      (i.style.cssText =
        "position:fixed;top:0;left:0;width:2em;height:2em;padding:0;border:none;outline:none;box-shadow:none;background:transparent;font-size:16px;"),
      document.body.appendChild(i),
      /iPad|iPhone|iPod/.test(navigator.userAgent))
    ) {
      const a = document.createRange();
      a.selectNodeContents(i);
      const d = window.getSelection();
      (d == null || d.removeAllRanges(),
        d == null || d.addRange(a),
        i.setSelectionRange(0, t.length));
    } else (i.focus(), i.select());
    let l = !1;
    try {
      l = document.execCommand("copy");
    } catch {
      console.warn("execCommand copy failed");
    }
    return (document.body.removeChild(i), l);
  }
  function Re() {
    document.body.classList.contains("modal-open") ||
      ((e.scrollLockY = window.scrollY || 0),
      document.body.classList.add("modal-open"),
      (document.body.style.position = "fixed"),
      (document.body.style.top = `-${e.scrollLockY}px`),
      (document.body.style.left = "0"),
      (document.body.style.right = "0"),
      (document.body.style.width = "100%"));
  }
  function Oe() {
    if (!document.body.classList.contains("modal-open")) return;
    (document.body.classList.remove("modal-open"),
      (document.body.style.position = ""),
      (document.body.style.top = ""),
      (document.body.style.left = ""),
      (document.body.style.right = ""),
      (document.body.style.width = ""));
    const t = e.scrollLockY || 0;
    ((e.scrollLockY = 0), window.scrollTo(0, t));
  }
  function N() {
    if (e.videoTimers)
      for (const t of Object.keys(e.videoTimers)) {
        const i = e.videoTimers[t];
        (i && clearTimeout(i), (e.videoTimers[t] = null));
      }
  }
  function $() {
    var i;
    (N(),
      e.videoStatusInterval &&
        (clearInterval(e.videoStatusInterval), (e.videoStatusInterval = null)),
      _());
    const t = (i = n.modalContent) == null ? void 0 : i.querySelector("video");
    if (t) {
      [
        "loadstart",
        "waiting",
        "canplaythrough",
        "playing",
        "error",
        "stalled",
        "seeking",
        "seeked",
        "abort",
        "ended",
      ].forEach((l) => {
        t["on" + l] = null;
      });
      try {
        t.pause();
      } catch {}
      ((t.src = ""), t.load(), t.remove());
    }
  }
  function ae() {
    ($(), M("Connections reset"));
  }
  function F(t) {
    var i;
    (n.overlayMessage && (n.overlayMessage.textContent = t),
      (i = n.videoOverlay) == null || i.classList.add("show"));
  }
  function _() {
    var t;
    (t = n.videoOverlay) == null || t.classList.remove("show");
  }
  function U() {
    ($(),
      setTimeout(() => {
        (X(), M("Video reloaded"));
      }, 200));
  }
  const j = [0.5, 0.75, 1, 1.25, 1.5, 2];
  let R = 2;
  function X() {
    const t = e.filteredFiles[e.currentIndex];
    if (!t) {
      Y();
      return;
    }
    ($(), n.modalContent && (n.modalContent.innerHTML = ""));
    const i = t.path || t.name,
      o = t.inline_url || `/api/public/dl/${e.shareHash}/${L(i)}?inline=true`,
      l = V(i, t.size || 0),
      r = t.download_url || `/api/share/${e.shareHash}/file/${L(i)}?download=1`;
    (n.modalTitle && (n.modalTitle.textContent = t.name),
      n.modalMeta &&
        (n.modalMeta.textContent = `${e.currentIndex + 1} of ${e.filteredFiles.length} ‚Ä¢ ${I(t.size)}`),
      n.viewOriginal && (n.viewOriginal.href = o),
      n.download && ((n.download.href = r), (n.download.download = t.name)),
      t.type === "video"
        ? (n.speedBtn && (n.speedBtn.style.display = "inline-flex"),
          n.resetVideoBtn && (n.resetVideoBtn.style.display = "inline-flex"),
          ze(o, l, t))
        : (n.speedBtn && (n.speedBtn.style.display = "none"),
          n.resetVideoBtn && (n.resetVideoBtn.style.display = "none"),
          t.type === "image" && n.modalContent
            ? (n.modalContent.innerHTML = `<img class="modal-media zoomable" src="${o}" alt="${t.name}" style="transform:scale(1)">`)
            : n.modalContent &&
              (n.modalContent.innerHTML = `
          <div style="text-align:center;padding:2rem;">
              <div style="font-size:4rem;margin-bottom:1rem;">${me(t.extension)}</div>
              <p>Preview not available</p>
              <a href="${r}" class="action-btn" style="margin-top:1rem;display:inline-flex;">‚¨áÔ∏è Download</a>
          </div>`)));
  }
  function ze(t, i, o) {
    var c;
    const l = document.createElement("div");
    l.style.cssText =
      "position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;";
    const r = document.createElement("video");
    ((r.className = "modal-media"),
      (r.controls = !0),
      (r.autoplay = !0),
      (r.playsInline = !0),
      (r.preload = "metadata"),
      (r.poster = i),
      (r.innerHTML = `<source src="${t}">`),
      l.appendChild(r),
      (c = n.modalContent) == null || c.appendChild(l),
      e.videoStatusInterval &&
        (clearInterval(e.videoStatusInterval), (e.videoStatusInterval = null)));
    function a() {
      const u = `${e.currentIndex + 1} of ${e.filteredFiles.length} ‚Ä¢ ${I((o == null ? void 0 : o.size) || 0)}`,
        h = Number.isFinite(r.duration) ? r.duration : null;
      if (!h || h <= 0) {
        n.modalMeta && (n.modalMeta.textContent = u);
        return;
      }
      let v = 0,
        y = 0;
      const w = Number.isFinite(r.currentTime) ? r.currentTime : 0;
      try {
        const g = r.buffered;
        for (let b = 0; b < g.length; b++) {
          const k = g.start(b),
            T = g.end(b);
          !Number.isFinite(k) ||
            !Number.isFinite(T) ||
            T <= k ||
            ((v += T - k), w >= k && w <= T && (y = Math.max(y, T - w)));
        }
      } catch {}
      const s = Math.max(0, Math.min(1, v / h));
      let f = ` ‚Ä¢ Buffered ${Math.round(s * 100)}%`;
      const p = Number((o == null ? void 0 : o.size) || 0);
      (Number.isFinite(p) && p > 0 && (f += ` (‚âà${I(p * s)} / ${I(p)})`),
        y > 0 && (f += ` ‚Ä¢ Ahead ${Math.round(y)}s`),
        n.modalMeta && (n.modalMeta.textContent = u + f));
    }
    (a(),
      (e.videoStatusInterval = setInterval(a, 500)),
      r.addEventListener("progress", a),
      r.addEventListener("timeupdate", a),
      r.addEventListener("loadedmetadata", a),
      r.addEventListener("seeking", a),
      r.addEventListener("seeked", a),
      (r.playbackRate = j[R]));
    let d = !1;
    (e.videoTimers.stuck && clearTimeout(e.videoTimers.stuck),
      (e.videoTimers.stuck = setTimeout(() => {
        !d && !r.paused && F("Video stuck - tap anywhere to reload");
      }, S.STUCK_TIMEOUT)),
      (r.onplaying = () => {
        ((d = !0), _(), N());
      }),
      (r.oncanplaythrough = () => {
        _();
      }),
      (r.onwaiting = () => {
        d &&
          (e.videoTimers.wait && clearTimeout(e.videoTimers.wait),
          (e.videoTimers.wait = setTimeout(() => {
            r.readyState < 3 && F("Buffering... tap to reload if stuck");
          }, S.STUCK_TIMEOUT)));
      }),
      (r.onseeking = () => {
        (e.videoTimers.seek && clearTimeout(e.videoTimers.seek),
          (e.videoTimers.seek = setTimeout(() => {
            r.seeking && F("Seek stuck - tap anywhere to reload");
          }, S.SEEK_TIMEOUT)));
      }),
      (r.onseeked = () => {
        (_(),
          e.videoTimers.seek && (clearTimeout(e.videoTimers.seek), (e.videoTimers.seek = null)));
      }),
      (r.onerror = () => {
        (_(), N(), M("Video failed to load"));
      }),
      (r.onstalled = () => {
        (e.videoTimers.stall && clearTimeout(e.videoTimers.stall),
          (e.videoTimers.stall = setTimeout(() => {
            r.readyState < 3 && F("Video stalled - tap to reload");
          }, S.STUCK_TIMEOUT)));
      }));
  }
  const de = document.getElementById("speedBtn");
  de &&
    (de.onclick = () => {
      var o;
      R = (R + 1) % j.length;
      const t = j[R];
      n.speedBtn && (n.speedBtn.textContent = t === 1 ? "1x" : t + "x");
      const i = (o = n.modalContent) == null ? void 0 : o.querySelector("video");
      (i && (i.playbackRate = t), M(`Speed: ${t}x`));
    });
  const ce = document.getElementById("resetVideoBtn");
  ce && (ce.onclick = U);
  function K(t) {
    if (t < 0 || t >= e.filteredFiles.length) return;
    ((e.currentIndex = t),
      (e.isZoomed = !1),
      (e.zoomScale = 1),
      (e.pinchStartDistance = null),
      (e.pinchStartScale = 1));
    const i = document.getElementById("zoomBtn");
    (i && (i.textContent = "üîç"),
      e.isSlideshow && A(),
      Re(),
      n.modal &&
        ((n.modal.style.display = "block"), n.modal.offsetHeight, n.modal.classList.add("show")),
      X(),
      q(),
      ue());
  }
  window.openModal = K;
  function Ae(t, i) {
    const o = e.filteredFiles[t];
    if (o) {
      if (o.type === "video") {
        const l = o.path || o.name,
          r = `/player?share=${encodeURIComponent(e.shareHash || "")}&file=${encodeURIComponent(l)}`;
        i != null && i.shiftKey ? K(t) : (window.location.href = r);
        return;
      }
      K(t);
    }
  }
  window.openMedia = Ae;
  function Y() {
    var t;
    ($(),
      e.isSlideshow &&
        (e.slideshowInterval && clearInterval(e.slideshowInterval), (e.isSlideshow = !1)),
      (e.isZoomed = !1),
      (e.zoomScale = 1),
      (e.pinchStartDistance = null),
      (e.pinchStartScale = 1),
      e.immersiveTimer && clearTimeout(e.immersiveTimer),
      (t = n.modal) == null || t.classList.remove("show", "immersive"),
      setTimeout(() => {
        var i;
        ((i = n.modal) != null && i.classList.contains("show")) ||
          (n.modal && (n.modal.style.display = "none"),
          n.modalContent && (n.modalContent.innerHTML = ""),
          Oe());
      }, 300));
  }
  function B(t) {
    const i = e.currentIndex + t;
    if (i >= 0 && i < e.filteredFiles.length) {
      ((e.isZoomed = !1),
        (e.zoomScale = 1),
        (e.pinchStartDistance = null),
        (e.pinchStartScale = 1));
      const o = document.getElementById("zoomBtn");
      o && (o.textContent = "üîç");
      const l = e.filteredFiles[i];
      (e.isSlideshow && (l == null ? void 0 : l.type) === "video" && A(),
        (e.currentIndex = i),
        X(),
        q(),
        ue());
    }
  }
  function q() {
    var t;
    ((t = n.modal) == null || t.classList.add("active-user"),
      e.immersiveTimer && clearTimeout(e.immersiveTimer),
      (e.immersiveTimer = setTimeout(() => {
        var i;
        return (i = n.modal) == null ? void 0 : i.classList.remove("active-user");
      }, 3e3)));
  }
  const x = new Map();
  function De(t) {
    if (x.has(t)) return;
    if (x.size >= S.MAX_PRELOAD_CACHE) {
      const o = x.keys().next().value;
      o && x.delete(o);
    }
    const i = new Image();
    ((i.src = t), x.set(t, i));
  }
  function Pe() {
    [-1, 1].forEach((t) => {
      const i = e.currentIndex + t;
      if (i >= 0 && i < e.filteredFiles.length) {
        const o = e.filteredFiles[i];
        if (o.type === "image") {
          const l = o.path || o.name,
            r = o.inline_url || `/api/public/dl/${e.shareHash}/${L(l)}?inline=true`;
          De(r);
        }
      }
    });
  }
  function ue() {
    const t = e.filteredFiles[e.currentIndex];
    (t == null ? void 0 : t.type) === "image" && Pe();
  }
  function me(t) {
    const i = (t || "").toLowerCase();
    return (
      {
        pdf: "üìï",
        doc: "üìÑ",
        docx: "üìÑ",
        txt: "üìù",
        xls: "üìä",
        xlsx: "üìä",
        csv: "üìä",
        ppt: "üìΩÔ∏è",
        pptx: "üìΩÔ∏è",
        zip: "üì¶",
        rar: "üì¶",
        "7z": "üì¶",
        mp3: "üéµ",
        wav: "üéµ",
        flac: "üéµ",
        html: "üåê",
        css: "üé®",
        js: "‚öôÔ∏è",
        json: "üìã",
        py: "üêç",
        java: "‚òï",
      }[i] || "üìÑ"
    );
  }
  async function O(t = !1) {
    const i = new URLSearchParams();
    t && i.set("refresh", "1");
    const o = new URLSearchParams(window.location.search).get("recursive");
    if (o == null) i.set("recursive", "1");
    else {
      const a = String(o).trim().toLowerCase(),
        d = a === "1" || a === "true" || a === "yes" || a === "on" ? "1" : "0";
      i.set("recursive", d);
    }
    i.set("v", String(Date.now()));
    const l = new AbortController(),
      r = setTimeout(() => l.abort(), 15e3);
    try {
      const a = await fetch(`/api/share/${e.shareHash}/files?${i}`, {
        cache: "no-store",
        signal: l.signal,
      });
      if (!a.ok) throw new Error(`Failed: ${a.status}`);
      ((e.files = await a.json()), z());
    } finally {
      clearTimeout(r);
    }
  }
  function z() {
    (n.loading && (n.loading.style.display = "none"), n.error && (n.error.style.display = "none"));
    const t = e.search.toLowerCase(),
      i = e.files.filter((a) => a.name.toLowerCase().includes(t)),
      o = document.getElementById("countAll"),
      l = document.getElementById("countImages"),
      r = document.getElementById("countVideos");
    (o && (o.textContent = String(i.length)),
      l && (l.textContent = String(i.filter((a) => a.type === "image").length)),
      r && (r.textContent = String(i.filter((a) => a.type === "video").length)),
      (e.filteredFiles = e.files.filter((a) => {
        const d = e.filter === "all" || a.type === e.filter,
          c = a.name.toLowerCase().includes(t);
        return d && c;
      })),
      e.filteredFiles.sort((a, d) => {
        const c = (u) => (u === "image" ? 1 : u === "video" ? 2 : 3);
        switch (e.sort) {
          case "type_asc":
            return c(a.type) - c(d.type) || a.name.localeCompare(d.name);
          case "type_desc":
            return c(d.type) - c(a.type) || a.name.localeCompare(d.name);
          case "name_asc":
            return a.name.localeCompare(d.name);
          case "name_desc":
            return d.name.localeCompare(a.name);
          case "size_asc":
            return a.size - d.size;
          case "size_desc":
            return d.size - a.size;
          default:
            return 0;
        }
      }),
      Ue());
  }
  function W() {
    e.showDetails &&
      (D && clearTimeout(D),
      (D = setTimeout(() => {
        le().catch(() => {});
      }, 120)));
  }
  function Ve() {
    var t, i;
    (e.virtual.observer && e.virtual.observer.disconnect(),
      (t = e.virtual.sentinel) != null &&
        t.parentNode &&
        e.virtual.sentinel.parentNode.removeChild(e.virtual.sentinel),
      (e.virtual.enabled = !1),
      (e.virtual.rendered = 0),
      (e.virtual.sentinel = null),
      (e.virtual.observer = null),
      (e.virtual.inFlight = !1),
      (i = n.grid) == null || i.classList.remove("virtualized"));
  }
  function He() {
    const t = document.createElement("div");
    return ((t.className = "virtual-sentinel"), t.setAttribute("aria-hidden", "true"), t);
  }
  function Z(t, i) {
    var l, r;
    const o = document.createDocumentFragment();
    for (let a = t; a < i; a++) {
      const d = e.filteredFiles[a];
      if (!d) continue;
      const c = document.createElement("div");
      ((c.className = "media-card"), (c.innerHTML = je(d, a)), o.appendChild(c));
    }
    e.virtual.sentinel
      ? (l = n.grid) == null || l.insertBefore(o, e.virtual.sentinel)
      : (r = n.grid) == null || r.appendChild(o);
  }
  function fe() {
    if (!e.virtual.enabled || e.virtual.inFlight) return;
    e.virtual.inFlight = !0;
    const t = e.virtual.rendered,
      i = Math.min(t + S.VIRTUAL_CHUNK_SIZE, e.filteredFiles.length);
    if (t >= i) {
      ((e.virtual.inFlight = !1),
        e.virtual.observer && e.virtual.observer.disconnect(),
        e.virtual.sentinel && (e.virtual.sentinel.remove(), (e.virtual.sentinel = null)));
      return;
    }
    (Z(t, i),
      (e.virtual.rendered = i),
      e.virtual.rendered >= e.filteredFiles.length &&
        (e.virtual.observer && e.virtual.observer.disconnect(),
        e.virtual.sentinel && (e.virtual.sentinel.remove(), (e.virtual.sentinel = null))),
      (e.virtual.inFlight = !1),
      W());
  }
  function Ne() {
    var t;
    if (e.virtual.sentinel) {
      if (!("IntersectionObserver" in window)) {
        (Z(e.virtual.rendered, e.filteredFiles.length),
          (e.virtual.rendered = e.filteredFiles.length),
          (e.virtual.enabled = !1),
          (t = n.grid) == null || t.classList.remove("virtualized"),
          e.virtual.sentinel && (e.virtual.sentinel.remove(), (e.virtual.sentinel = null)),
          W());
        return;
      }
      ((e.virtual.observer = new IntersectionObserver(
        (i) => {
          i.some((o) => o.isIntersecting) && fe();
        },
        { rootMargin: `0px 0px ${S.VIRTUAL_PREFETCH_PX}px 0px` }
      )),
        e.virtual.observer.observe(e.virtual.sentinel));
    }
  }
  function Ue() {
    var i, o;
    if ((Ve(), n.grid && (n.grid.innerHTML = ""), e.filteredFiles.length === 0)) {
      (n.emptyTitle &&
        (n.emptyTitle.textContent =
          e.files.length === 0 ? "This share is empty" : "No files found"),
        n.emptyMessage &&
          (n.emptyMessage.textContent =
            e.files.length === 0
              ? "No files have been shared yet."
              : "Try adjusting your search or filters"),
        n.empty && (n.empty.style.display = "block"));
      return;
    }
    (n.empty && (n.empty.style.display = "none"),
      e.filteredFiles.length > S.VIRTUAL_SCROLL_THRESHOLD
        ? ((e.virtual.enabled = !0),
          (e.virtual.rendered = 0),
          (i = n.grid) == null || i.classList.add("virtualized"),
          (e.virtual.sentinel = He()),
          (o = n.grid) == null || o.appendChild(e.virtual.sentinel),
          fe(),
          Ne())
        : (Z(0, e.filteredFiles.length), W()));
  }
  function je(t, i) {
    const o = t.path || t.name,
      l = t.inline_url || `/api/public/dl/${e.shareHash}/${L(o)}?inline=true`,
      r = t.download_url || `/api/share/${e.shareHash}/file/${L(o)}?download=1`,
      a = V(o, t.size || 0),
      d = Le(o, t.size || 0),
      c = d ? `srcset="${d}" sizes="${ve}"` : "",
      u = t.type === "video",
      h = t.type === "image";
    let v = "";
    return (
      h
        ? (v = `
        <img class="media-preview" src="${a}" ${c} data-fallback="${l}" loading="lazy" decoding="async" fetchpriority="low" alt="${t.name}"
             onerror="this.onerror=null;this.src=this.dataset.fallback;">`)
        : u
          ? (v = `
        <img class="media-preview" src="${a}" ${c} loading="lazy" decoding="async" fetchpriority="low" alt="${t.name}"
             style="object-fit:cover;height:200px;width:100%;"
             onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="file-placeholder" style="background:#000;display:none;height:200px;align-items:center;justify-content:center;">
            <div style="font-size:2.75rem">üéûÔ∏è</div>
        </div>
        <div class="play-icon">‚ñ∂</div>`)
          : (v = `<div class="file-placeholder">${me(t.extension)} ${t.extension.toUpperCase()}</div>`),
      `
      <div class="media-preview-container" onclick="openMedia(${i}, event)">
          <div class="media-tag">${u ? "Video" : h ? "Image" : "File"}</div>
          ${v}
      </div>
      <div class="media-info">
          <div class="media-title">
              <div class="media-name">${t.name}</div>
              ${u ? `<div class="video-details" data-video-meta="1" data-path="${encodeURIComponent(o)}">Loading‚Ä¶</div>` : ""}
          </div>
          <div class="media-meta"><span>${t.extension.toUpperCase()}</span><span>${I(t.size)}</span></div>
          <div class="card-actions">
              <button class="card-btn primary" onclick="openMedia(${i}, event)">${u ? "Play" : "View"}</button>
              <a href="${r}" download="${t.name}" class="card-btn">‚¨á</a>
          </div>
      </div>`
    );
  }
  function A() {
    var i, o;
    e.isSlideshow = !e.isSlideshow;
    const t = document.getElementById("slideshowBtn");
    (t && (t.textContent = e.isSlideshow ? "‚è∏" : "‚ñ∂"),
      e.isSlideshow
        ? ((i = n.modal) == null || i.classList.add("immersive"),
          (e.slideshowInterval = setInterval(() => {
            (e.currentIndex < e.filteredFiles.length - 1 || (e.currentIndex = -1), B(1));
          }, S.SLIDESHOW_INTERVAL)))
        : (e.slideshowInterval && clearInterval(e.slideshowInterval),
          (o = n.modal) == null || o.classList.remove("immersive")));
  }
  function Xe() {
    if (!n.pullToRefresh) return;
    const t = n.pullToRefresh,
      i = 70,
      o = 120;
    let l = null;
    function r() {
      ((t.style.height = "0px"),
        t.classList.remove("ready", "refreshing"),
        (t.textContent = "Pull to refresh"),
        (e.isPulling = !1));
    }
    (window.addEventListener(
      "touchstart",
      (a) => {
        var d;
        e.isRefreshing ||
          ((d = n.modal) == null ? void 0 : d.style.display) === "block" ||
          window.scrollY > 0 ||
          ((l = a.touches[0].screenY), (e.isPulling = !0));
      },
      { passive: !0 }
    ),
      window.addEventListener(
        "touchmove",
        (a) => {
          if (!e.isPulling || l === null || e.isRefreshing) return;
          const d = a.touches[0].screenY - l;
          if (d <= 0) return;
          const c = Math.min(d, o);
          ((t.style.height = `${c}px`),
            t.classList.toggle("ready", c >= i),
            (t.textContent = c >= i ? "Release to refresh" : "Pull to refresh"));
        },
        { passive: !0 }
      ),
      window.addEventListener(
        "touchend",
        () => {
          if (!e.isPulling) return;
          if (!t.classList.contains("ready")) {
            (r(), (l = null));
            return;
          }
          ((e.isRefreshing = !0),
            t.classList.remove("ready"),
            t.classList.add("refreshing"),
            (t.style.height = "56px"),
            (t.textContent = "Refreshing‚Ä¶"),
            O(!0)
              .catch(console.error)
              .finally(() => {
                ((e.isRefreshing = !1), r());
              }),
            (l = null));
        },
        { passive: !0 }
      ));
  }
  function Ke() {
    var w;
    n.videoOverlay &&
      (n.videoOverlay.onclick = (s) => {
        (s.preventDefault(), s.stopPropagation(), U());
      });
    let t;
    (n.search &&
      (n.search.oninput = (s) => {
        (clearTimeout(t),
          (t = setTimeout(() => {
            ((e.search = s.target.value), z());
          }, 150)));
      }),
      n.sort &&
        (n.sort.onchange = (s) => {
          ((e.sort = s.target.value), C({ sort: e.sort }), z());
        }),
      n.filters.forEach((s) => {
        s.onclick = () => {
          (n.filters.forEach((m) => {
            (m.classList.remove("active"), m.setAttribute("aria-pressed", "false"));
          }),
            s.classList.add("active"),
            s.setAttribute("aria-pressed", "true"),
            (e.filter = s.dataset.filter || "all"),
            C({ filter: e.filter }),
            z());
        };
      }),
      n.copyLink &&
        (n.copyLink.onclick = async () => {
          const s = await Fe(window.location.href);
          M(s ? "Link copied" : "Copy failed - select and copy manually");
        }),
      n.streamBtn &&
        (n.streamBtn.onclick = () => {
          const s = "/stream/" + e.shareHash;
          window.open(s, "_blank");
        }),
      n.refresh &&
        (n.refresh.onclick = (s) => {
          s.shiftKey ? (ae(), location.reload()) : O(!0).catch(console.error);
        }),
      n.details && (n.details.onclick = () => re(!e.showDetails)));
    const i = document.getElementById("closeBtn"),
      o = document.getElementById("prevBtn"),
      l = document.getElementById("nextBtn"),
      r = document.getElementById("slideshowBtn"),
      a = document.getElementById("zoomBtn"),
      d = document.getElementById("fullscreenBtn"),
      c = document.getElementById("gridViewBtn"),
      u = document.getElementById("listViewBtn"),
      h = document.getElementById("helpBtn"),
      v = document.getElementById("closeHelpBtn");
    (i && (i.onclick = Y),
      o && (o.onclick = () => B(-1)),
      l && (l.onclick = () => B(1)),
      r && (r.onclick = A),
      a &&
        (a.onclick = () => {
          var f;
          const s = (f = n.modalContent) == null ? void 0 : f.querySelector(".modal-media");
          if (!s || s.tagName !== "IMG") return;
          const m = e.zoomScale > 1.05 ? 1 : 1.5;
          oe(m);
        }),
      d &&
        (d.onclick = () => {
          var s, m, f, p, g;
          document.fullscreenElement
            ? ((s = document.exitFullscreen) == null || s.call(document),
              (m = n.modal) == null || m.classList.remove("immersive"))
            : ((p = (f = n.modal) == null ? void 0 : f.requestFullscreen) == null || p.call(f),
              (g = n.modal) == null || g.classList.add("immersive"));
        }),
      c &&
        (c.onclick = () => {
          var s;
          ((e.layout = "grid"),
            C({ layout: "grid" }),
            (s = n.grid) == null || s.classList.remove("list-view"),
            c.classList.add("active"),
            u == null || u.classList.remove("active"));
        }),
      u &&
        (u.onclick = () => {
          var s;
          ((e.layout = "list"),
            C({ layout: "list" }),
            (s = n.grid) == null || s.classList.add("list-view"),
            u.classList.add("active"),
            c == null || c.classList.remove("active"));
        }),
      window.addEventListener("scroll", () => {
        var s;
        (s = n.backToTop) == null || s.classList.toggle("show", window.scrollY > 500);
      }),
      n.backToTop && (n.backToTop.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" })),
      h &&
        (h.onclick = () => {
          var s;
          return (s = n.helpOverlay) == null ? void 0 : s.classList.add("show");
        }),
      v &&
        (v.onclick = () => {
          var s;
          return (s = n.helpOverlay) == null ? void 0 : s.classList.remove("show");
        }),
      n.helpOverlay &&
        (n.helpOverlay.onclick = (s) => {
          var m;
          s.target === n.helpOverlay && ((m = n.helpOverlay) == null || m.classList.remove("show"));
        }),
      document.addEventListener("keydown", (s) => {
        var m, f, p, g, b, k, T;
        if (s.key === "?" || (s.key === "/" && s.shiftKey)) {
          (s.preventDefault(), (m = n.helpOverlay) == null || m.classList.toggle("show"));
          return;
        }
        if (s.key === "Escape") {
          (f = n.helpOverlay) != null && f.classList.contains("show")
            ? (p = n.helpOverlay) == null || p.classList.remove("show")
            : ((g = n.modal) == null ? void 0 : g.style.display) === "block" && Y();
          return;
        }
        if (s.key === "k" || s.key === "K") {
          (s.preventDefault(), ae());
          return;
        }
        if (
          (s.key === "r" || s.key === "R") &&
          ((b = n.modal) == null ? void 0 : b.style.display) === "block"
        ) {
          const G = e.filteredFiles[e.currentIndex];
          (G == null ? void 0 : G.type) === "video" && (s.preventDefault(), U());
          return;
        }
        ((k = n.modal) == null ? void 0 : k.style.display) === "block" &&
          (s.key === "ArrowLeft"
            ? B(-1)
            : s.key === "ArrowRight"
              ? B(1)
              : s.key === " " &&
                ((T = e.filteredFiles[e.currentIndex]) == null ? void 0 : T.type) !== "video" &&
                (s.preventDefault(), A()));
      }));
    function y(s) {
      var p, g;
      const m = e.filteredFiles[e.currentIndex];
      if (!m || m.type !== "image") return !1;
      const f = s;
      return !!(
        f &&
        (((p = f.classList) != null && p.contains("modal-media")) ||
          ((g = f.closest) != null && g.call(f, ".modal-media")))
      );
    }
    (n.modalContent &&
      (n.modalContent.addEventListener(
        "touchstart",
        (s) => {
          if (s.touches && s.touches.length === 2 && y(s.target)) {
            const p = ie(s.touches);
            (p && ((e.pinchStartDistance = p), (e.pinchStartScale = e.zoomScale || 1)),
              (e.touchStartX = null));
            return;
          }
          const m = e.filteredFiles[e.currentIndex];
          if ((m == null ? void 0 : m.type) === "video") {
            e.touchStartX = null;
            return;
          }
          const f = s.target;
          if (f.tagName === "VIDEO" || f.closest("video")) {
            e.touchStartX = null;
            return;
          }
          e.touchStartX = s.changedTouches[0].screenX;
        },
        { passive: !0 }
      ),
      n.modalContent.addEventListener(
        "touchmove",
        (s) => {
          if (!e.pinchStartDistance || !y(s.target)) return;
          const m = ie(s.touches);
          if (!m) return;
          const f = e.pinchStartScale * (m / e.pinchStartDistance);
          (oe(f), s.preventDefault());
        },
        { passive: !1 }
      ),
      n.modalContent.addEventListener(
        "touchend",
        (s) => {
          if (
            (e.pinchStartDistance &&
              (!s.touches || s.touches.length < 2) &&
              ((e.pinchStartDistance = null), (e.pinchStartScale = e.zoomScale || 1)),
            e.touchStartX === null)
          )
            return;
          const m = e.filteredFiles[e.currentIndex];
          if ((m == null ? void 0 : m.type) === "video") return;
          const f = s.target;
          if (f.tagName === "VIDEO" || f.closest("video")) return;
          const p = e.touchStartX - s.changedTouches[0].screenX;
          Math.abs(p) > 50 && B(p > 0 ? 1 : -1);
        },
        { passive: !0 }
      )),
      (w = n.modal) == null || w.addEventListener("mousemove", q),
      document.addEventListener("visibilitychange", () => {
        var s, m;
        if (document.hidden && ((s = n.modal) == null ? void 0 : s.style.display) === "block") {
          const f = (m = n.modalContent) == null ? void 0 : m.querySelector("video");
          f && f.pause();
        }
      }),
      window.addEventListener("beforeunload", () => {
        ($(), x.clear());
      }),
      window.addEventListener("online", () => {
        var s;
        ((e.isOffline = !1),
          (s = n.offlineBanner) == null || s.classList.remove("show"),
          e.files.length === 0 && O(!0).catch(console.error));
      }),
      window.addEventListener("offline", () => {
        var s;
        ((e.isOffline = !0), (s = n.offlineBanner) == null || s.classList.add("show"));
      }),
      document.addEventListener("fullscreenchange", () => {
        var s;
        document.fullscreenElement || (s = n.modal) == null || s.classList.remove("immersive");
      }),
      Xe());
  }
  async function he() {
    var o, l, r, a, d, c;
    if (
      (Se(),
      Te(),
      xe(),
      (e.shareHash =
        new URLSearchParams(window.location.search).get("share") ||
        window.location.pathname
          .split("/")
          .filter((u) => u && u !== "gallery")
          .pop() ||
        null),
      !e.shareHash || e.shareHash === "gallery")
    ) {
      (n.loading && (n.loading.style.display = "none"),
        n.errorTitle && (n.errorTitle.textContent = "Invalid share link"),
        n.errorMessage && (n.errorMessage.textContent = "Please use a valid Dropbox share link."),
        n.error && (n.error.style.display = "block"));
      return;
    }
    const t = P();
    ((e.filter = t.filter || "all"),
      (e.sort = t.sort || "type_asc"),
      (e.showDetails = t.show_details !== void 0 ? !!t.show_details : !0));
    const i =
      (l = (o = window.matchMedia) == null ? void 0 : o.call(window, "(max-width: 900px)")) == null
        ? void 0
        : l.matches;
    ((e.layout = t.layout || (we || i ? "list" : "grid")),
      n.sort && (n.sort.value = e.sort),
      n.filters.forEach((u) => {
        const h = u.dataset.filter === e.filter;
        (u.classList.toggle("active", h), u.setAttribute("aria-pressed", h ? "true" : "false"));
      }),
      e.layout === "list" &&
        ((r = n.grid) == null || r.classList.add("list-view"),
        (a = document.getElementById("listViewBtn")) == null || a.classList.add("active"),
        (d = document.getElementById("gridViewBtn")) == null || d.classList.remove("active")),
      re(e.showDetails, { skipSave: !0 }),
      Ke(),
      n.downloadAll && (n.downloadAll.href = `/api/share/${e.shareHash}/download`),
      e.isOffline && ((c = n.offlineBanner) == null || c.classList.add("show")));
    try {
      await O();
    } catch (u) {
      (console.error(u),
        n.loading && (n.loading.style.display = "none"),
        n.errorTitle && (n.errorTitle.textContent = "Failed to load gallery"),
        n.errorMessage &&
          (n.errorMessage.textContent =
            u instanceof Error ? u.message : "Please check your connection."),
        n.error && (n.error.style.display = "block"));
    }
  }
  document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", he) : he();
})();
//# sourceMappingURL=gallery.min.js.map
