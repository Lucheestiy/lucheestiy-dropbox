!function(){"use strict";const e=6e3,t=8e3,n=15,i=4e3,o=100,s=60,l=1200,a=window.DROPPR_CONFIG||{},r=[240,320,480,640,800],d=function(e){const t=(Array.isArray(e)?e:[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)&&e>0);if(0===t.length)return r.slice();t.sort((e,t)=>e-t);const n=[];return t.forEach(e=>{n[n.length-1]!==e&&n.push(e)}),n}(a.previewWidths),c=String(a.previewFormat||"auto").trim().toLowerCase(),u="string"==typeof a.previewSizes&&a.previewSizes.trim()?a.previewSizes.trim():"(max-width: 600px) 100vw, (max-width: 900px) 50vw, (max-width: 1200px) 33vw, 25vw",m="string"==typeof a.assetBaseUrl?a.assetBaseUrl.replace(/\/+$/,""):"",h=navigator.userAgent||"",v=/iPad|iPhone|iPod/.test(h)||"MacIntel"===navigator.platform&&(navigator.maxTouchPoints||0)>1,f={files:[],filteredFiles:[],currentIndex:0,shareHash:null,filter:"all",sort:"type_asc",layout:"grid",showDetails:!0,search:"",isSlideshow:!1,slideshowInterval:null,isZoomed:!1,zoomScale:1,immersiveTimer:null,touchStartX:null,pinchStartDistance:null,pinchStartScale:1,isPulling:!1,isRefreshing:!1,isOffline:!navigator.onLine,videoTimers:{stuck:null,wait:null,seek:null,stall:null},videoStatusInterval:null,scrollLockY:0,videoMetaCache:{},videoMetaInFlight:{},virtual:{enabled:!1,rendered:0,sentinel:null,observer:null,inFlight:!1}},p={};let y=null;const g="droppr_gallery_prefs";function w(){try{return JSON.parse(localStorage.getItem(g)||"{}")}catch{return{}}}function b(e){try{localStorage.setItem(g,JSON.stringify({...w(),...e}))}catch{}}function I(){return w().theme||"dark"}function S(e){const t="dark"===e;document.documentElement.setAttribute("data-theme",e),p.themeToggle&&(p.themeToggle.textContent=t?"üåô":"‚òÄÔ∏è",p.themeToggle.title=t?"Switch to light theme":"Switch to dark theme"),b({theme:e})}function B(){S("dark"===I()?"light":"dark")}function L(e){return String(e||"").split("/").map(e=>encodeURIComponent(e)).join("/")}function k(e,t,n){let i=`/api/share/${f.shareHash}/preview/${L(e)}?v=${t||0}`;return n&&(i+=`&w=${n}`),c&&(i+=`&format=${encodeURIComponent(c)}`),i}function x(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1e3));return t<=0?Math.round(e)+" B":(e/Math.pow(1e3,t)).toFixed(1)+" "+["B","KB","MB","GB"][t]}function T(e){if(!e||e.length<2)return null;const t=e[0].screenX-e[1].screenX,n=e[0].screenY-e[1].screenY;return Math.sqrt(t*t+n*n)}function E(e){const t=p.modalContent.querySelector(".modal-media");var n,i,o;t&&"IMG"===t.tagName&&(f.zoomScale=(n=e,i=1,o=3,Math.min(o,Math.max(i,n))),f.isZoomed=f.zoomScale>1.05,t.style.transform=`scale(${f.zoomScale})`,t.classList.toggle("zoomable",!0),document.getElementById("zoomBtn").textContent=f.isZoomed?"üîé":"üîç")}function $(){!function(e){if(!e||"string"!=typeof e)return;const t=e.replace(/\/+$/,"");if(!t||t===window.location.origin)return;if(document.querySelector(`link[rel="preconnect"][href="${t}"]`))return;const n=document.createElement("link");n.rel="preconnect",n.href=t,n.crossOrigin="anonymous",document.head.appendChild(n);const i=document.createElement("link");i.rel="dns-prefetch",i.href=t,document.head.appendChild(i)}(m)}function C(e,t){if(!e||"object"!=typeof e){const e=Number(t);return Number.isFinite(e)&&e>0?x(e):"‚Äî"}const n=e.video&&"object"==typeof e.video?e.video:{},i=e.audio&&"object"==typeof e.audio?e.audio:{};let o=null;Number.isFinite(Number(t))&&Number(t)>0?o=Number(t):Number.isFinite(Number(e.size))&&Number(e.size)>0&&(o=Number(e.size));const s=parseInt(String(n.display_width||n.width||""),10),l=parseInt(String(n.display_height||n.height||""),10),a=!isNaN(s)&&!isNaN(l)&&s>0&&l>0?`${s}√ó${l}`:"",r=n.codec?String(n.codec).toUpperCase():"",d=i.codec?String(i.codec).toUpperCase():"",c=r?d?`${r}/${d}`:r:d||"",u=function(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return"";const n=Math.floor(t),i=Math.floor(n/3600),o=Math.floor(n%3600/60),s=n%60;return i>0?`${i}:${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}`:`${o}:${String(s).padStart(2,"0")}`}(e.duration),m=Number(n.fps),h=Number.isFinite(m)&&m>0?Math.round(100*m)/100+"fps":"";return[o?x(o):"",a,c,u,h].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"}function M(e,t={}){const n=!!e;f.showDetails=n,document.body.classList.toggle("show-details",n),p.details&&(p.details.textContent=f.showDetails?"‚Ñπ Details: On":"‚Ñπ Details: Off"),t.skipSave||b({show_details:n}),n&&N()}async function F(e){const t=`/api/share/${f.shareHash}/video-meta/${L(e)}?t=${Date.now()}`,n=await fetch(t,{cache:"no-store"});return n.ok?await n.json():null}function z(e,t){if(!e)return;if(!t||"object"!=typeof t)return e.innerHTML='<span class="line">Details unavailable</span>',void(e.dataset.loaded="1");const n=[];if(t.recorded){const e=function(e){if(null==e)return"";const t=parseInt(String(e),10);if(!Number.isFinite(t)||t<=0)return"";try{return new Date(1e3*t).toLocaleString()}catch{return""}}(t.uploaded_at);e&&n.push(`Uploaded: ${e}`);const i=C(t.original,t.original_size),o=C(t.processed,t.processed_size);n.push(`Original: ${i}`);const s=function(e){const t=String(e||"").toLowerCase();return"transcode_hevc_to_h264"===t?"Transcoded HEVC ‚Üí H.264":"fix_video_errors_extra_streams"===t?"Re-encoded (removed extra streams)":"fix_video_errors_timestamp"===t?"Re-encoded (fixed timestamps)":"faststart"===t?"Faststart (moov moved)":"already_faststart"===t?"Already faststart":"none"===t?"No changes":e?String(e):""}(t.action);n.push(`After: ${o}${s?` ‚Ä¢ ${s}`:""}`)}else{const e=t.current&&t.current.size?x(t.current.size):"";n.push(e?`Size: ${e}`:"No video metadata recorded yet")}e.innerHTML=n.map(e=>`<span class="line">${e}</span>`).join(""),e.dataset.loaded="1"}async function N(){if(!f.showDetails)return;const e=Array.from(document.querySelectorAll('.video-details[data-video-meta="1"]')).filter(e=>e&&!e.dataset.loaded&&e.dataset.path);if(!e.length)return;let t=0;const n=Math.min(4,e.length);async function i(){for(;t<e.length;){const n=e[t++],i=String(n.dataset.path||"");let o=i;try{o=decodeURIComponent(i)}catch{}const s=`${f.shareHash}:${o}`;if(f.videoMetaCache[s])z(n,f.videoMetaCache[s]);else if(!f.videoMetaInFlight[s]){f.videoMetaInFlight[s]=!0;try{const e=await F(o);e&&(f.videoMetaCache[s]=e),z(n,e)}catch(e){z(n,null)}finally{delete f.videoMetaInFlight[s]}}}}const o=[];for(let e=0;e<n;e++)o.push(i());await Promise.all(o)}function D(e){const t=document.getElementById("toast");document.getElementById("toastMessage").textContent=e,t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),3e3)}function O(){if(f.videoTimers)for(const e of Object.keys(f.videoTimers)){const t=f.videoTimers[e];t&&clearTimeout(t),f.videoTimers[e]=null}}function _(){O(),f.videoStatusInterval&&(clearInterval(f.videoStatusInterval),f.videoStatusInterval=null),P();const e=p.modalContent.querySelector("video");if(e){["loadstart","waiting","canplaythrough","playing","error","stalled","seeking","seeked","abort","ended"].forEach(t=>e["on"+t]=null);try{e.pause()}catch(e){}e.src="",e.load(),e.remove()}}function R(){_(),D("Connections reset")}function H(e){p.overlayMessage.textContent=e,p.videoOverlay.classList.add("show")}function P(){p.videoOverlay.classList.remove("show")}function A(){_(),setTimeout(()=>{U(),D("Video reloaded")},200)}const V=[.5,.75,1,1.25,1.5,2];let j=2;function U(){const n=f.filteredFiles[f.currentIndex];if(!n)return void X();_(),p.modalContent.innerHTML="";const i=n.path||n.name,o=n.inline_url||`/api/public/dl/${f.shareHash}/${L(i)}?inline=true`,s=k(i,n.size||0),l=n.download_url||`/api/share/${f.shareHash}/file/${L(i)}?download=1`;p.modalTitle.textContent=n.name,p.modalMeta.textContent=`${f.currentIndex+1} of ${f.filteredFiles.length} ‚Ä¢ ${x(n.size)}`,p.viewOriginal.href=o,p.download.href=l,p.download.download=n.name,"video"===n.type?(p.speedBtn.style.display="inline-flex",p.resetVideoBtn.style.display="inline-flex",function(n,i,o){const s=document.createElement("div");s.style.cssText="position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;";const l=document.createElement("video");l.className="modal-media",l.controls=!0,l.autoplay=!0,l.playsInline=!0,l.preload="metadata",l.poster=i,l.innerHTML=`<source src="${n}">`,s.appendChild(l),p.modalContent.appendChild(s),f.videoStatusInterval&&(clearInterval(f.videoStatusInterval),f.videoStatusInterval=null);function a(){const e=`${f.currentIndex+1} of ${f.filteredFiles.length} ‚Ä¢ ${x(o?.size||0)}`,t=Number.isFinite(l.duration)?l.duration:null;if(!t||t<=0)return void(p.modalMeta.textContent=e);let n=0,i=0;const s=Number.isFinite(l.currentTime)?l.currentTime:0;try{const e=l.buffered;for(let t=0;t<e.length;t++){const o=e.start(t),l=e.end(t);!Number.isFinite(o)||!Number.isFinite(l)||l<=o||(n+=l-o,s>=o&&s<=l&&(i=Math.max(i,l-s)))}}catch(e){}const a=Math.max(0,Math.min(1,n/t));let r=` ‚Ä¢ Buffered ${Math.round(100*a)}%`;const d=Number(o?.size||0);Number.isFinite(d)&&d>0&&(r+=` (‚âà${x(d*a)} / ${x(d)})`),i>0&&(r+=` ‚Ä¢ Ahead ${Math.round(i)}s`),p.modalMeta.textContent=e+r}a(),f.videoStatusInterval=setInterval(a,500),l.addEventListener("progress",a),l.addEventListener("timeupdate",a),l.addEventListener("loadedmetadata",a),l.addEventListener("seeking",a),l.addEventListener("seeked",a),l.playbackRate=V[j];let r=!1,d=!1;f.videoTimers.stuck&&clearTimeout(f.videoTimers.stuck);f.videoTimers.stuck=setTimeout(()=>{d||l.paused||(r=!0,H("Video stuck - tap anywhere to reload"))},e),l.onplaying=()=>{d=!0,r=!1,P(),O()},l.oncanplaythrough=()=>{P()},l.onwaiting=()=>{d&&(f.videoTimers.wait&&clearTimeout(f.videoTimers.wait),f.videoTimers.wait=setTimeout(()=>{l.readyState<3&&H("Buffering... tap to reload if stuck")},e))},l.onseeking=()=>{f.videoTimers.seek&&clearTimeout(f.videoTimers.seek),f.videoTimers.seek=setTimeout(()=>{l.seeking&&H("Seek stuck - tap anywhere to reload")},t)},l.onseeked=()=>{P(),f.videoTimers.seek&&(clearTimeout(f.videoTimers.seek),f.videoTimers.seek=null)},l.onerror=()=>{P(),O(),D("Video failed to load")},l.onstalled=()=>{f.videoTimers.stall&&clearTimeout(f.videoTimers.stall),f.videoTimers.stall=setTimeout(()=>{l.readyState<3&&H("Video stalled - tap to reload")},e)}}(o,s,n)):(p.speedBtn.style.display="none",p.resetVideoBtn.style.display="none","image"===n.type?p.modalContent.innerHTML=`<img class="modal-media zoomable" src="${o}" alt="${n.name}" style="transform:scale(1)">`:p.modalContent.innerHTML=`\n                        <div style="text-align:center;padding:2rem;">\n                            <div style="font-size:4rem;margin-bottom:1rem;">${W(n.extension)}</div>\n                            <p>Preview not available</p>\n                            <a href="${l}" class="action-btn" style="margin-top:1rem;display:inline-flex;">‚¨áÔ∏è Download</a>\n                        </div>`)}function Y(e){e<0||e>=f.filteredFiles.length||(f.currentIndex=e,f.isZoomed=!1,f.zoomScale=1,f.pinchStartDistance=null,f.pinchStartScale=1,document.getElementById("zoomBtn").textContent="üîç",f.isSlideshow&&se(),document.body.classList.contains("modal-open")||(f.scrollLockY=window.scrollY||0,document.body.classList.add("modal-open"),document.body.style.position="fixed",document.body.style.top=`-${f.scrollLockY}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.width="100%"),p.modal.style.display="block",p.modal.offsetHeight,p.modal.classList.add("show"),U(),Z(),J())}function X(){_(),f.isSlideshow&&(clearInterval(f.slideshowInterval),f.isSlideshow=!1),f.isZoomed=!1,f.zoomScale=1,f.pinchStartDistance=null,f.pinchStartScale=1,clearTimeout(f.immersiveTimer),p.modal.classList.remove("show","immersive"),setTimeout(()=>{p.modal.classList.contains("show")||(p.modal.style.display="none",p.modalContent.innerHTML="",function(){if(!document.body.classList.contains("modal-open"))return;document.body.classList.remove("modal-open"),document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.width="";const e=f.scrollLockY||0;f.scrollLockY=0,window.scrollTo(0,e)}())},300)}function q(e){const t=f.currentIndex+e;if(t>=0&&t<f.filteredFiles.length){f.isZoomed=!1,f.zoomScale=1,f.pinchStartDistance=null,f.pinchStartScale=1,document.getElementById("zoomBtn").textContent="üîç";const e=f.filteredFiles[t];f.isSlideshow&&"video"===e?.type&&se(),f.currentIndex=t,U(),Z(),J()}}function Z(){p.modal.classList.add("active-user"),clearTimeout(f.immersiveTimer),f.immersiveTimer=setTimeout(()=>p.modal.classList.remove("active-user"),3e3)}document.getElementById("speedBtn").onclick=()=>{j=(j+1)%V.length;const e=V[j];p.speedBtn.textContent=1===e?"1x":e+"x";const t=p.modalContent.querySelector("video");t&&(t.playbackRate=e),D(`Speed: ${e}x`)},document.getElementById("resetVideoBtn").onclick=A,window.openModal=Y,window.openMedia=function(e,t){const n=f.filteredFiles[e];if(n){if("video"===n.type){const i=n.path||n.name,o=`/player?share=${encodeURIComponent(f.shareHash)}&file=${encodeURIComponent(i)}`;return void(t&&t.shiftKey?Y(e):window.location.href=o)}Y(e)}};const G=new Map;function K(){[-1,1].forEach(e=>{const t=f.currentIndex+e;if(t>=0&&t<f.filteredFiles.length){const e=f.filteredFiles[t];if("image"===e.type){const t=e.path||e.name;!function(e){if(G.has(e))return;if(G.size>=n){const e=G.keys().next().value;G.delete(e)}const t=new Image;t.src=e,G.set(e,t)}(e.inline_url||`/api/public/dl/${f.shareHash}/${L(t)}?inline=true`)}}})}function J(){const e=f.filteredFiles[f.currentIndex];"image"===e?.type&&K()}function W(e){return{pdf:"üìï",doc:"üìÑ",docx:"üìÑ",txt:"üìù",xls:"üìä",xlsx:"üìä",csv:"üìä",ppt:"üìΩÔ∏è",pptx:"üìΩÔ∏è",zip:"üì¶",rar:"üì¶","7z":"üì¶",mp3:"üéµ",wav:"üéµ",flac:"üéµ",html:"üåê",css:"üé®",js:"‚öôÔ∏è",json:"üìã",py:"üêç",java:"‚òï"}[(e||"").toLowerCase()]||"üìÑ"}async function Q(e=!1){const t=new URLSearchParams;e&&t.set("refresh","1");const n=new URLSearchParams(window.location.search).get("recursive");if(null==n)t.set("recursive","1");else{const e=String(n).trim().toLowerCase(),i="1"===e||"true"===e||"yes"===e||"on"===e?"1":"0";t.set("recursive",i)}t.set("v",Date.now());const i=new AbortController,o=setTimeout(()=>i.abort(),15e3);try{const e=await fetch(`/api/share/${f.shareHash}/files?${t}`,{cache:"no-store",signal:i.signal});if(!e.ok)throw new Error(`Failed: ${e.status}`);f.files=await e.json(),ee()}finally{clearTimeout(o)}}function ee(){p.loading.style.display="none",p.error.style.display="none";const e=f.search.toLowerCase(),t=f.files.filter(t=>t.name.toLowerCase().includes(e));document.getElementById("countAll").textContent=t.length,document.getElementById("countImages").textContent=t.filter(e=>"image"===e.type).length,document.getElementById("countVideos").textContent=t.filter(e=>"video"===e.type).length,f.filteredFiles=f.files.filter(t=>{const n="all"===f.filter||t.type===f.filter,i=t.name.toLowerCase().includes(e);return n&&i}),f.filteredFiles.sort((e,t)=>{const n=e=>"image"===e?1:"video"===e?2:3;switch(f.sort){case"type_asc":return n(e.type)-n(t.type)||e.name.localeCompare(t.name);case"type_desc":return n(t.type)-n(e.type)||e.name.localeCompare(t.name);case"name_asc":return e.name.localeCompare(t.name);case"name_desc":return t.name.localeCompare(e.name);case"size_asc":return e.size-t.size;case"size_desc":return t.size-e.size;default:return 0}}),function(){if(function(){f.virtual.observer&&f.virtual.observer.disconnect();f.virtual.sentinel&&f.virtual.sentinel.parentNode&&f.virtual.sentinel.parentNode.removeChild(f.virtual.sentinel);f.virtual.enabled=!1,f.virtual.rendered=0,f.virtual.sentinel=null,f.virtual.observer=null,f.virtual.inFlight=!1,p.grid&&p.grid.classList.remove("virtualized")}(),p.grid.innerHTML="",0===f.filteredFiles.length)return p.emptyTitle.textContent=0===f.files.length?"This share is empty":"No files found",p.emptyMessage.textContent=0===f.files.length?"No files have been shared yet.":"Try adjusting your search or filters",void(p.empty.style.display="block");p.empty.style.display="none";f.filteredFiles.length>o?(f.virtual.enabled=!0,f.virtual.rendered=0,p.grid.classList.add("virtualized"),f.virtual.sentinel=function(){const e=document.createElement("div");return e.className="virtual-sentinel",e.setAttribute("aria-hidden","true"),e}(),p.grid.appendChild(f.virtual.sentinel),ie(),function(){if(!f.virtual.sentinel)return;if(!("IntersectionObserver"in window))return ne(f.virtual.rendered,f.filteredFiles.length),f.virtual.rendered=f.filteredFiles.length,f.virtual.enabled=!1,p.grid.classList.remove("virtualized"),f.virtual.sentinel&&(f.virtual.sentinel.remove(),f.virtual.sentinel=null),void te();f.virtual.observer=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&ie()},{rootMargin:`0px 0px ${l}px 0px`}),f.virtual.observer.observe(f.virtual.sentinel)}()):(ne(0,f.filteredFiles.length),te())}()}function te(){f.showDetails&&(clearTimeout(y),y=setTimeout(()=>{N().catch(()=>{})},120))}function ne(e,t){const n=document.createDocumentFragment();for(let i=e;i<t;i++){const e=f.filteredFiles[i];if(!e)continue;const t=document.createElement("div");t.className="media-card",t.innerHTML=oe(e,i),n.appendChild(t)}f.virtual.sentinel?p.grid.insertBefore(n,f.virtual.sentinel):p.grid.appendChild(n)}function ie(){if(!f.virtual.enabled||f.virtual.inFlight)return;f.virtual.inFlight=!0;const e=f.virtual.rendered,t=Math.min(e+s,f.filteredFiles.length);if(e>=t)return f.virtual.inFlight=!1,f.virtual.observer&&f.virtual.observer.disconnect(),void(f.virtual.sentinel&&(f.virtual.sentinel.remove(),f.virtual.sentinel=null));ne(e,t),f.virtual.rendered=t,f.virtual.rendered>=f.filteredFiles.length&&(f.virtual.observer&&f.virtual.observer.disconnect(),f.virtual.sentinel&&(f.virtual.sentinel.remove(),f.virtual.sentinel=null)),f.virtual.inFlight=!1,te()}function oe(e,t){const n=e.path||e.name,i=e.inline_url||`/api/public/dl/${f.shareHash}/${L(n)}?inline=true`,o=e.download_url||`/api/share/${f.shareHash}/file/${L(n)}?download=1`,s=k(n,e.size||0),l=function(e,t){return d.length?d.map(n=>`${k(e,t,n)} ${n}w`).join(", "):""}(n,e.size||0),a=l?`srcset="${l}" sizes="${u}"`:"",r="video"===e.type,c="image"===e.type;let m="";m=c?`\n                    <img class="media-preview" src="${s}" ${a} data-fallback="${i}" loading="lazy" decoding="async" fetchpriority="low" alt="${e.name}"\n                         onerror="this.onerror=null;this.src=this.dataset.fallback;">`:r?`\n                    <img class="media-preview" src="${s}" ${a} loading="lazy" decoding="async" fetchpriority="low" alt="${e.name}"\n                         style="object-fit:cover;height:200px;width:100%;"\n                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">\n                    <div class="file-placeholder" style="background:#000;display:none;height:200px;align-items:center;justify-content:center;">\n                        <div style="font-size:2.75rem">üéûÔ∏è</div>\n                    </div>\n                    <div class="play-icon">‚ñ∂</div>`:`<div class="file-placeholder">${W(e.extension)} ${e.extension.toUpperCase()}</div>`;return`\n                <div class="media-preview-container" onclick="openMedia(${t}, event)">\n                    <div class="media-tag">${r?"Video":c?"Image":"File"}</div>\n                    ${m}\n                </div>\n                <div class="media-info">\n                    <div class="media-title">\n                        <div class="media-name">${e.name}</div>\n                        ${r?`<div class="video-details" data-video-meta="1" data-path="${encodeURIComponent(n)}">Loading‚Ä¶</div>`:""}\n                    </div>\n                    <div class="media-meta"><span>${e.extension.toUpperCase()}</span><span>${x(e.size)}</span></div>\n                    <div class="card-actions">\n                        <button class="card-btn primary" onclick="openMedia(${t}, event)">${r?"Play":"View"}</button>\n                        <a href="${o}" download="${e.name}" class="card-btn">‚¨á</a>\n                    </div>\n                </div>`}function se(){f.isSlideshow=!f.isSlideshow,document.getElementById("slideshowBtn").textContent=f.isSlideshow?"‚è∏":"‚ñ∂",f.isSlideshow?(p.modal.classList.add("immersive"),f.slideshowInterval=setInterval(()=>{f.currentIndex<f.filteredFiles.length-1||(f.currentIndex=-1),q(1)},i)):(clearInterval(f.slideshowInterval),p.modal.classList.remove("immersive"))}function le(){let e;p.videoOverlay.onclick=function(e){e.preventDefault(),e.stopPropagation(),A()},p.search.oninput=t=>{clearTimeout(e),e=setTimeout(()=>{f.search=t.target.value,ee()},150)},p.sort.onchange=e=>{f.sort=e.target.value,b({sort:f.sort}),ee()},p.filters.forEach(e=>{e.onclick=()=>{p.filters.forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")}),e.classList.add("active"),e.setAttribute("aria-pressed","true"),f.filter=e.dataset.filter,b({filter:f.filter}),ee()}}),p.copyLink.onclick=async()=>{D(await async function(e){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(e),!0}catch(e){console.warn("Clipboard API failed, trying fallback:",e)}const t=document.createElement("textarea");if(t.value=e,t.setAttribute("readonly",""),t.style.cssText="position:fixed;top:0;left:0;width:2em;height:2em;padding:0;border:none;outline:none;box-shadow:none;background:transparent;font-size:16px;",document.body.appendChild(t),/iPad|iPhone|iPod/.test(navigator.userAgent)){const n=document.createRange();n.selectNodeContents(t);const i=window.getSelection();i.removeAllRanges(),i.addRange(n),t.setSelectionRange(0,e.length)}else t.focus(),t.select();let n=!1;try{n=document.execCommand("copy")}catch(e){console.warn("execCommand copy failed:",e)}return document.body.removeChild(t),n}(window.location.href)?"Link copied":"Copy failed - select and copy manually")},p.streamBtn.onclick=()=>{const e="/stream/"+f.shareHash;window.open(e,"_blank")},p.refresh.onclick=e=>{e.shiftKey?(R(),location.reload()):Q(!0).catch(console.error)},p.details&&(p.details.onclick=()=>M(!f.showDetails)),document.getElementById("closeBtn").onclick=X,document.getElementById("prevBtn").onclick=()=>q(-1),document.getElementById("nextBtn").onclick=()=>q(1),document.getElementById("slideshowBtn").onclick=se,document.getElementById("zoomBtn").onclick=()=>{const e=p.modalContent.querySelector(".modal-media");if(!e||"IMG"!==e.tagName)return;E(f.zoomScale>1.05?1:1.5)},document.getElementById("fullscreenBtn").onclick=()=>{document.fullscreenElement?(document.exitFullscreen?.(),p.modal.classList.remove("immersive")):(p.modal.requestFullscreen?.(),p.modal.classList.add("immersive"))};const t=document.getElementById("gridViewBtn"),n=document.getElementById("listViewBtn");function i(e){const t=f.filteredFiles[f.currentIndex];return!(!t||"image"!==t.type)&&!(!e||!e.classList?.contains("modal-media")&&!e.closest?.(".modal-media"))}t.onclick=()=>{f.layout="grid",b({layout:"grid"}),p.grid.classList.remove("list-view"),t.classList.add("active"),n.classList.remove("active")},n.onclick=()=>{f.layout="list",b({layout:"list"}),p.grid.classList.add("list-view"),n.classList.add("active"),t.classList.remove("active")},window.addEventListener("scroll",()=>{p.backToTop.classList.toggle("show",window.scrollY>500)}),p.backToTop.onclick=()=>window.scrollTo({top:0,behavior:"smooth"}),document.getElementById("helpBtn").onclick=()=>p.helpOverlay.classList.add("show"),document.getElementById("closeHelpBtn").onclick=()=>p.helpOverlay.classList.remove("show"),p.helpOverlay.onclick=e=>{e.target===p.helpOverlay&&p.helpOverlay.classList.remove("show")},document.addEventListener("keydown",e=>{if("?"===e.key||"/"===e.key&&e.shiftKey)return e.preventDefault(),void p.helpOverlay.classList.toggle("show");if("Escape"!==e.key){if("k"===e.key||"K"===e.key)return e.preventDefault(),void R();if(("r"===e.key||"R"===e.key)&&"block"===p.modal.style.display){const t=f.filteredFiles[f.currentIndex];return void("video"===t?.type&&(e.preventDefault(),A()))}"block"===p.modal.style.display&&("ArrowLeft"===e.key?q(-1):"ArrowRight"===e.key?q(1):" "===e.key&&"video"!==f.filteredFiles[f.currentIndex]?.type&&(e.preventDefault(),se()))}else p.helpOverlay.classList.contains("show")?p.helpOverlay.classList.remove("show"):"block"===p.modal.style.display&&X()}),p.modalContent.addEventListener("touchstart",e=>{if(e.touches&&2===e.touches.length&&i(e.target)){const t=T(e.touches);return t&&(f.pinchStartDistance=t,f.pinchStartScale=f.zoomScale||1),void(f.touchStartX=null)}const t=f.filteredFiles[f.currentIndex];"video"!==t?.type?"VIDEO"===e.target.tagName||e.target.closest("video")?f.touchStartX=null:f.touchStartX=e.changedTouches[0].screenX:f.touchStartX=null},{passive:!0}),p.modalContent.addEventListener("touchmove",e=>{if(!f.pinchStartDistance||!i(e.target))return;const t=T(e.touches);if(!t)return;E(f.pinchStartScale*(t/f.pinchStartDistance)),e.preventDefault()},{passive:!1}),p.modalContent.addEventListener("touchend",e=>{if(f.pinchStartDistance&&(!e.touches||e.touches.length<2)&&(f.pinchStartDistance=null,f.pinchStartScale=f.zoomScale||1),null===f.touchStartX)return;const t=f.filteredFiles[f.currentIndex];if("video"===t?.type)return;if("VIDEO"===e.target.tagName||e.target.closest("video"))return;const n=f.touchStartX-e.changedTouches[0].screenX;Math.abs(n)>50&&q(n>0?1:-1)},{passive:!0}),p.modal.addEventListener("mousemove",Z),document.addEventListener("visibilitychange",()=>{if(document.hidden&&"block"===p.modal.style.display){const e=p.modalContent.querySelector("video");e&&e.pause()}}),window.addEventListener("beforeunload",()=>{_(),G.clear()}),window.addEventListener("online",()=>{f.isOffline=!1,p.offlineBanner.classList.remove("show"),0===f.files.length&&Q(!0).catch(console.error)}),window.addEventListener("offline",()=>{f.isOffline=!0,p.offlineBanner.classList.add("show")}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||p.modal.classList.remove("immersive")}),function(){if(!p.pullToRefresh)return;const e=p.pullToRefresh;let t=null;function n(){e.style.height="0px",e.classList.remove("ready","refreshing"),e.textContent="Pull to refresh",f.isPulling=!1}window.addEventListener("touchstart",e=>{f.isRefreshing||"block"===p.modal.style.display||window.scrollY>0||(t=e.touches[0].screenY,f.isPulling=!0)},{passive:!0}),window.addEventListener("touchmove",n=>{if(!f.isPulling||null===t||f.isRefreshing)return;const i=n.touches[0].screenY-t;if(i<=0)return;const o=Math.min(i,120);e.style.height=`${o}px`,e.classList.toggle("ready",o>=70),e.textContent=o>=70?"Release to refresh":"Pull to refresh"},{passive:!0}),window.addEventListener("touchend",()=>{if(f.isPulling)return e.classList.contains("ready")?(f.isRefreshing=!0,e.classList.remove("ready"),e.classList.add("refreshing"),e.style.height="56px",e.textContent="Refreshing‚Ä¶",Q(!0).catch(console.error).finally(()=>{f.isRefreshing=!1,n()}),void(t=null)):(n(),void(t=null))},{passive:!0})}()}async function ae(){if(p.grid=document.getElementById("galleryGrid"),p.loading=document.getElementById("loading"),p.empty=document.getElementById("emptyState"),p.emptyTitle=document.getElementById("emptyTitle"),p.emptyMessage=document.getElementById("emptyMessage"),p.error=document.getElementById("errorState"),p.errorTitle=document.getElementById("errorTitle"),p.errorMessage=document.getElementById("errorMessage"),p.search=document.getElementById("searchInput"),p.sort=document.getElementById("sortSelect"),p.filters=document.querySelectorAll(".filter-btn"),p.modal=document.getElementById("modal"),p.modalContent=document.getElementById("modalContent"),p.modalTitle=document.getElementById("modalTitle"),p.modalMeta=document.getElementById("modalMeta"),p.downloadAll=document.getElementById("downloadAllBtn"),p.copyLink=document.getElementById("copyLinkBtn"),p.streamBtn=document.getElementById("streamBtn"),p.refresh=document.getElementById("refreshBtn"),p.details=document.getElementById("detailsBtn"),p.backToTop=document.getElementById("backToTop"),p.viewOriginal=document.getElementById("viewOriginalBtn"),p.download=document.getElementById("downloadBtn"),p.videoOverlay=document.getElementById("videoOverlay"),p.overlayMessage=document.getElementById("overlayMessage"),p.speedBtn=document.getElementById("speedBtn"),p.resetVideoBtn=document.getElementById("resetVideoBtn"),p.helpOverlay=document.getElementById("helpOverlay"),p.offlineBanner=document.getElementById("offlineBanner"),p.pullToRefresh=document.getElementById("pullToRefresh"),p.themeToggle=document.getElementById("themeToggle"),S(I()),p.themeToggle&&p.themeToggle.addEventListener("click",B),$(),f.shareHash=new URLSearchParams(window.location.search).get("share")||window.location.pathname.split("/").filter(e=>e&&"gallery"!==e).pop(),!f.shareHash||"gallery"===f.shareHash)return p.loading.style.display="none",p.errorTitle.textContent="Invalid share link",p.errorMessage.textContent="Please use a valid Dropbox share link.",void(p.error.style.display="block");const e=w();f.filter=e.filter||"all",f.sort=e.sort||"type_asc",f.showDetails=void 0===e.show_details||!!e.show_details;const t=window.matchMedia?.("(max-width: 900px)")?.matches;f.layout=e.layout||(v||t?"list":"grid"),p.sort.value=f.sort,p.filters.forEach(e=>{const t=e.dataset.filter===f.filter;e.classList.toggle("active",t),e.setAttribute("aria-pressed",t?"true":"false")}),"list"===f.layout&&(p.grid.classList.add("list-view"),document.getElementById("listViewBtn").classList.add("active"),document.getElementById("gridViewBtn").classList.remove("active")),M(f.showDetails,{skipSave:!0}),le(),p.downloadAll.href=`/api/share/${f.shareHash}/download`,f.isOffline&&p.offlineBanner.classList.add("show");try{await Q()}catch(e){console.error(e),p.loading.style.display="none",p.errorTitle.textContent="Failed to load gallery",p.errorMessage.textContent=e.message||"Please check your connection.",p.error.style.display="block"}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",ae):ae()}();