groups:
- name: droppr_alerts
  rules:
  - alert: HighMediaProcessingErrorRate
    expr: rate(droppr_video_transcode_count_total{status="error"}[5m]) / rate(droppr_video_transcode_count_total[5m]) > 0.1
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High media processing error rate ({{ $value | humanizePercentage }})"
      description: "More than 10% of video transcodes failed in the last 5 minutes."

  - alert: MediaProcessingLatencyHigh
    expr: droppr_video_transcode_latency_seconds_sum / droppr_video_transcode_latency_seconds_count > 60
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: "Media processing latency is high"
      description: "Average transcode time is over 60 seconds."

  - alert: RedisConnectionDown
    expr: droppr_health_status{service="redis"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis connection down"
      description: "Media server cannot connect to Redis."

  - alert: DatabaseError
    expr: droppr_health_status{service="database"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "SQLite Database error"
      description: "Media server encountered an error with the analytics database."

  - alert: HighHttpErrorRate
    expr: sum(rate(droppr_http_requests_total{status=~"5.."}[5m])) / sum(rate(droppr_http_requests_total[5m])) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High HTTP 5xx error rate ({{ $value | humanizePercentage }})"
      description: "More than 5% of requests returned 5xx errors in the last 5 minutes."

  - alert: HighLatencyAPI
    expr: histogram_quantile(0.95, sum(rate(droppr_http_request_duration_seconds_bucket[5m])) by (le)) > 2
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High 95th percentile latency"
      description: "95% of requests are slower than 2 seconds."
